[{"content":"errors åŒ…ä¸ºä½ çš„ Go ç¨‹åºæä¾›ä¸€ç§å¯¹ç¨‹åºå‘˜è°ƒè¯•ã€æŸ¥çœ‹æ—¥å¿—æ›´å‹å¥½çš„é”™è¯¯å¤„ç†æ–¹å¼ã€‚\nGo ç¨‹åºä¸­ä¼ ç»Ÿçš„é”™è¯¯å¤„ç†æ–¹æ³•ï¼š\nif err != nil { return err } é€’å½’çš„å‘ä¸Šä¼ é€’é”™è¯¯ï¼Œè¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªç¼ºé™·ï¼šæœ€ç»ˆå¤„ç†é”™è¯¯çš„ä½ç½®æ— æ³•è·å–é”™è¯¯çš„è°ƒç”¨ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚\nerrors åŒ…ä»¥ä¸ç ´åé”™è¯¯çš„åŸå§‹å€¼çš„æ–¹å¼å‘é”™è¯¯ä¸­çš„æ·»åŠ è°ƒç”¨ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚\nè·å–åŒ… go get github.com/pkg/errors é”™è¯¯æ·»åŠ ä¸Šä¸‹æ–‡ The errors.Wrap function returns a new error that adds context to the original error. For example\n_, err := ioutil.ReadAll(r) if err != nil { return errors.Wrap(err, \u0026#34;read failed\u0026#34;) } Retrieving the cause of an error Using errors.Wrap constructs a stack of errors, adding context to the preceding error. Depending on the nature of the error it may be necessary to reverse the operation of errors.Wrap to retrieve the original error for inspection. Any error value which implements this interface can be inspected by errors.Cause.\ntype causer interface { Cause() error } errors.Cause will recursively retrieve the topmost error which does not implement causer, which is assumed to be the original cause. For example:\nswitch err := errors.Cause(err).(type) { case *MyError: // handle specifically default: // unknown error } Read the package documentation for more information.\nRoadmap With the upcoming Go2 error proposals this package is moving into maintenance mode. The roadmap for a 1.0 release is as follows:\n 0.9. Remove pre Go 1.9 and Go 1.10 support, address outstanding pull requests (if possible) 1.0. Final release.  Contributing Because of the Go2 errors changes, this package is not accepting proposals for new functionality. With that said, we welcome pull requests, bug fixes and issue reports.\nBefore sending a PR, please discuss your change by raising an issue.\nLicense BSD-2-Clause\n","permalink":"https://srcio.cn/series/programming-go/gopkg-errors/","summary":"errors åŒ…ä¸ºä½ çš„ Go ç¨‹åºæä¾›ä¸€ç§å¯¹ç¨‹åºå‘˜è°ƒè¯•ã€æŸ¥çœ‹æ—¥å¿—æ›´å‹å¥½çš„é”™è¯¯å¤„ç†æ–¹å¼ã€‚ Go ç¨‹åºä¸­ä¼ ç»Ÿçš„é”™è¯¯å¤„ç†æ–¹æ³•ï¼š if err != nil { return err } é€’å½’çš„å‘ä¸Šä¼ é€’é”™è¯¯ï¼Œè¿™ç§æ–¹å¼","title":"Go é”™è¯¯å¤„ç†"},{"content":"åœºæ™¯ä»‹ç» ä»æ•°æ®åº“è·å–åˆ°äº†èœå•åˆ—è¡¨æ•°æ®ï¼Œè¿™äº›èœå•æ•°æ®é€šè¿‡å­—æ®µ ParentID è¡¨ç¤ºçˆ¶å­å±‚çº§å…³ç³»ï¼Œç°åœ¨éœ€è¦å°†èœå•åˆ—è¡¨æ•°æ®è½¬æˆæ ‘çŠ¶çš„å®ä¾‹å¯¹è±¡ã€‚\næ•°æ®åº“å–å‡ºçš„åˆå§‹æ•°æ®ï¼š\nraw := []Menu{ {Name: \u0026#34;ä¸€çº§èœå• 1\u0026#34;, ID: 1, PID: 0}, {Name: \u0026#34;ä¸€çº§èœå• 2\u0026#34;, ID: 2, PID: 0}, {Name: \u0026#34;ä¸€çº§èœå• 3\u0026#34;, ID: 3, PID: 0}, {Name: \u0026#34;äºŒçº§èœå• 1-1\u0026#34;, ID: 11, PID: 1}, {Name: \u0026#34;äºŒçº§èœå• 1-2\u0026#34;, ID: 12, PID: 1}, {Name: \u0026#34;äºŒçº§èœå• 1-3\u0026#34;, ID: 13, PID: 1}, {Name: \u0026#34;äºŒçº§èœå• 2-1\u0026#34;, ID: 21, PID: 2}, {Name: \u0026#34;äºŒçº§èœå• 2-2\u0026#34;, ID: 22, PID: 2}, {Name: \u0026#34;äºŒçº§èœå• 2-3\u0026#34;, ID: 23, PID: 2}, } éœ€è¦å¾—åˆ°çš„ç›®æ ‡æ•°æ®ï¼š\n{ \u0026#34;name\u0026#34;:\u0026#34;æ ¹èœå•\u0026#34;, \u0026#34;id\u0026#34;:0, \u0026#34;pid\u0026#34;:0, \u0026#34;SubMenus\u0026#34;:[ { \u0026#34;name\u0026#34;:\u0026#34;ä¸€çº§èœå• 1\u0026#34;, \u0026#34;id\u0026#34;:1, \u0026#34;pid\u0026#34;:0, \u0026#34;SubMenus\u0026#34;:[ { \u0026#34;name\u0026#34;:\u0026#34;äºŒçº§èœå• 1-1\u0026#34;, \u0026#34;id\u0026#34;:11, \u0026#34;pid\u0026#34;:1 }, { \u0026#34;name\u0026#34;:\u0026#34;äºŒçº§èœå• 1-2\u0026#34;, \u0026#34;id\u0026#34;:12, \u0026#34;pid\u0026#34;:1 }, { \u0026#34;name\u0026#34;:\u0026#34;äºŒçº§èœå• 1-3\u0026#34;, \u0026#34;id\u0026#34;:13, \u0026#34;pid\u0026#34;:1 } ] }, { \u0026#34;name\u0026#34;:\u0026#34;ä¸€çº§èœå• 2\u0026#34;, \u0026#34;id\u0026#34;:2, \u0026#34;pid\u0026#34;:0, \u0026#34;SubMenus\u0026#34;:[ { \u0026#34;name\u0026#34;:\u0026#34;äºŒçº§èœå• 2-1\u0026#34;, \u0026#34;id\u0026#34;:21, \u0026#34;pid\u0026#34;:2 }, { \u0026#34;name\u0026#34;:\u0026#34;äºŒçº§èœå• 2-2\u0026#34;, \u0026#34;id\u0026#34;:22, \u0026#34;pid\u0026#34;:2 }, { \u0026#34;name\u0026#34;:\u0026#34;äºŒçº§èœå• 2-3\u0026#34;, \u0026#34;id\u0026#34;:23, \u0026#34;pid\u0026#34;:2 } ] }, { \u0026#34;name\u0026#34;:\u0026#34;ä¸€çº§èœå• 3\u0026#34;, \u0026#34;id\u0026#34;:3, \u0026#34;pid\u0026#34;:0 } ] } ä»£ç å®ç° package main import ( \u0026#34;encoding/json\u0026#34; \u0026#34;fmt\u0026#34; ) func main() { // æ•°æ®åº“é‡Œå­˜å‚¨çš„èœå• \trawMenus := []Menu{ {Name: \u0026#34;ä¸€çº§èœå• 1\u0026#34;, ID: 1, PID: 0}, {Name: \u0026#34;ä¸€çº§èœå• 2\u0026#34;, ID: 2, PID: 0}, {Name: \u0026#34;ä¸€çº§èœå• 3\u0026#34;, ID: 3, PID: 0}, {Name: \u0026#34;äºŒçº§èœå• 1-1\u0026#34;, ID: 11, PID: 1}, {Name: \u0026#34;äºŒçº§èœå• 1-2\u0026#34;, ID: 12, PID: 1}, {Name: \u0026#34;äºŒçº§èœå• 1-3\u0026#34;, ID: 13, PID: 1}, {Name: \u0026#34;äºŒçº§èœå• 2-1\u0026#34;, ID: 21, PID: 2}, {Name: \u0026#34;äºŒçº§èœå• 2-2\u0026#34;, ID: 22, PID: 2}, {Name: \u0026#34;äºŒçº§èœå• 2-3\u0026#34;, ID: 23, PID: 2}, } menu := \u0026amp;Menu{ Name: \u0026#34;æ ¹èœå•\u0026#34;, PID: 0, } for _, rm := range rawMenus { menu.setSubMenus(rm) } // æ‰“å°ç»“æœ \tb, _ := json.Marshal(menu) fmt.Println(string(b)) } type Menu struct { Name string `json:\u0026#34;name\u0026#34;` ID int `json:\u0026#34;id\u0026#34;` PID int `json:\u0026#34;pid\u0026#34;` SubMenus []Menu `json:\u0026#34;,omitempty\u0026#34;` } func (m *Menu) setSubMenus(menu Menu) bool { if menu.PID == m.ID { m.SubMenus = append(m.SubMenus, menu) return true } for i := range m.SubMenus { if m.SubMenus[i].setSubMenus(menu) { return true } } return false } æ³¨æ„äº‹é¡¹ Golang for éå†ä½¿ç”¨ for _, item := range slice æ—¶ï¼Œitem æ˜¯ä¸€ä»½éå†å…ƒç´ çš„å¤åˆ¶ï¼Œè€Œä½¿ç”¨ for i := range slice æ—¶ï¼Œslice[i] åˆ™æ˜¯éå†å…ƒç´ æœ¬èº«ï¼Œä½¿ç”¨æ—¶éœ€è¦æ³¨æ„åˆ‡ç‰‡æ‰©å®¹å¸¦æ¥çš„åœ°å€å˜åŒ–é—®é¢˜ã€‚\nå¯ä»¥å‚è€ƒè¿™ç¯‡æ¥ç†è§£ï¼šğŸ‘‰ğŸ»Golang åˆ‡ç‰‡æ‰©å®¹\n","permalink":"https://srcio.cn/series/programming-go/menu-recursive/","summary":"åœºæ™¯ä»‹ç» ä»æ•°æ®åº“è·å–åˆ°äº†èœå•åˆ—è¡¨æ•°æ®ï¼Œè¿™äº›èœå•æ•°æ®é€šè¿‡å­—æ®µ ParentID è¡¨ç¤ºçˆ¶å­å±‚çº§å…³ç³»ï¼Œç°åœ¨éœ€è¦å°†èœå•åˆ—è¡¨æ•°æ®è½¬æˆæ ‘çŠ¶çš„å®ä¾‹å¯¹è±¡ã€‚ æ•°æ®åº“å–å‡ºçš„åˆå§‹æ•°æ®","title":"æ•°ç»„é€’å½’æ„é€ å…·æœ‰çˆ¶å­å±‚çº§å…³ç³»çš„å¯¹è±¡"},{"content":" æ–‡ç« è½¬è½½è‡ªï¼šhttps://sataqiu.github.io/2019/09/09/architecting-kubernetes-clusters-choosing-a-worker-node-size\n åœ¨éƒ¨ç½² Kubernetes é›†ç¾¤æ—¶ï¼Œæ‚¨é¦–å…ˆä¼šæƒ³åˆ°çš„é—®é¢˜ä¹‹ä¸€ææ€•å°±æ˜¯ï¼šâ€œæˆ‘åº”è¯¥é€‰æ‹©ä½•ç§èµ„æºé…é¢çš„è®¡ç®—èŠ‚ç‚¹ä»¥åŠåº”è¯¥é…ç½®å¤šå°‘ä¸ªè¿™æ ·çš„èŠ‚ç‚¹æ‰èƒ½æ»¡è¶³è®¡ç®—éœ€æ±‚ï¼Ÿâ€ã€‚åˆ°åº•æ˜¯ä½¿ç”¨å°‘é‡çš„é«˜çº§æœåŠ¡å™¨è¿˜æ˜¯ä½¿ç”¨å¤§é‡çš„ä½ç«¯æœåŠ¡å™¨æ›´åˆ’ç®—ï¼Œæ›´èƒ½æ»¡è¶³éœ€æ±‚å‘¢ï¼Ÿæœ¬æ–‡å°†ä»å¤šä¸ªç»´åº¦é˜è¿°ä¸åŒçš„èµ„æºé…ç½®æ–¹å¼å„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼Œå¹¶ä»å®è·µè§’åº¦å‡ºå‘ç»™å‡ºè¿›è¡Œé›†ç¾¤è§„åˆ’çš„ä¸€èˆ¬æ–¹æ³•ã€‚\né›†ç¾¤å®¹é‡ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸‹æœ¬æ–‡å…³äºé›†ç¾¤å®¹é‡çš„å®šä¹‰ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ Kubernetes é›†ç¾¤çœ‹ä½œæ˜¯å°†ä¸€ç»„å•ä¸ªèŠ‚ç‚¹æŠ½è±¡ä¸ºäº†ä¸€ä¸ªå¤§çš„â€œè¶…çº§èŠ‚ç‚¹â€ã€‚è¿™ä¸ªè¶…çº§èŠ‚ç‚¹çš„æ€»è®¡ç®—å®¹é‡ï¼ˆå°± CPU å’Œå†…å­˜è€Œè¨€ï¼‰æ˜¯æ‰€æœ‰ç»„æˆèŠ‚ç‚¹èµ„æºå®¹é‡çš„æ€»å’Œï¼Œä¹Ÿå°±æ˜¯é›†ç¾¤å®¹é‡ã€‚æ˜¾ç„¶ï¼Œæ‚¨å¯ä»¥é‡‡ç”¨å¤šç§ä¸åŒçš„èµ„æºé…ç½®æ–¹å¼å®ç°æ—¢å®šçš„ç›®æ ‡é›†ç¾¤å®¹é‡ã€‚\nä¾‹å¦‚ï¼Œå‡å¦‚æ‚¨éœ€è¦ä¸€ä¸ªæ€»å®¹é‡ä¸º 8 ä¸ª CPU å’Œ 32GB å†…å­˜çš„é›†ç¾¤ã€‚\n ä¾‹å¦‚ï¼Œå› ä¸ºè¦åœ¨é›†ç¾¤ä¸Šè¿è¡Œçš„åº”ç”¨ç¨‹åºéœ€è¦æ­¤æ•°é‡çš„èµ„æºã€‚\n ä»¥ä¸‹æ˜¯å®ç°é›†ç¾¤çš„ä¸¤ç§å¯èƒ½æ–¹æ³•ï¼š\n é€šè¿‡è¿™ä¸¤ç§æ–¹å¼æ„å»ºçš„é›†ç¾¤æ‹¥æœ‰ç›¸åŒçš„èµ„æºå®¹é‡ï¼Œä½†æ˜¯ä¸€ç§æ˜¯ä½¿ç”¨ 4 ä¸ªè¾ƒå°çš„èŠ‚ç‚¹ï¼Œè€Œå¦ä¸€ç§æ˜¯ä½¿ç”¨ 2 ä¸ªè¾ƒå¤§çš„èŠ‚ç‚¹ã€‚\nç©¶ç«Ÿå“ªç§é…ç½®æ–¹å¼æ›´å¥½å‘¢ï¼Ÿ\nä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè®©æˆ‘ä»¬å¯¹æ¯”ä¸‹è¿™ä¸¤ä¸ªç›¸åçš„æ–¹å‘ï¼ˆå³æ›´å°‘çš„é«˜é…èŠ‚ç‚¹ä¸æ›´å¤šçš„ä½é…èŠ‚ç‚¹ï¼‰å„è‡ªçš„ä¼˜ç¼ºç‚¹ã€‚\n è¯·æ³¨æ„ï¼Œæœ¬æ–‡ä¸­çš„â€œèŠ‚ç‚¹â€å§‹ç»ˆä»£æŒ‡å·¥ä½œèŠ‚ç‚¹ã€‚é›†ç¾¤ä¸»èŠ‚ç‚¹æ•°é‡å’Œå¤§å°çš„é€‰æ‹©æ˜¯å®Œå…¨ä¸åŒçš„ä¸»é¢˜ã€‚\n æ›´å°‘çš„é«˜é…èŠ‚ç‚¹ è¿™æ–¹é¢æœ€æç«¯çš„ä¸€ä¸ªä¾‹å­å°±æ˜¯ç”±å•ä¸ªå·¥ä½œèŠ‚ç‚¹æä¾›æ•´ä¸ªé›†ç¾¤çš„è®¡ç®—å®¹é‡ã€‚\nåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œè¿™å°†æ˜¯ä¸€ä¸ªå…·æœ‰ 16 ä¸ª CPU å’Œ 16GB å†…å­˜çš„å•ä¸ªå·¥ä½œèŠ‚ç‚¹ã€‚\nä¼˜åŠ¿ è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ç§æ–¹æ³•å¯èƒ½å…·æœ‰çš„ä¼˜åŠ¿ã€‚\næ›´å°‘çš„ç®¡ç†å¼€é”€ ç®€å•æ¥è¯´ï¼Œç®¡ç†å°‘é‡æœºå™¨ç›¸æ¯”ç®¡ç†å¤§é‡æœºå™¨ä¼šæ›´çœåŠ›ã€‚å¯¹èŠ‚ç‚¹è¿›è¡Œå‡çº§å’Œæ‰“è¡¥ä¸çš„æ“ä½œèƒ½å¾ˆè¿…é€Ÿåœ°å®Œæˆï¼ŒèŠ‚ç‚¹é—´çš„åŒæ­¥ä¿æŒä¹Ÿæ›´å®¹æ˜“ã€‚æ­¤å¤–ï¼Œå¯¹äºå¾ˆå°‘çš„æœºå™¨è€Œè¨€ï¼Œé¢„æœŸæ•…éšœçš„ç»å¯¹æ•°é‡ä¹Ÿä¼šå°äºä½¿ç”¨å¤§é‡æœºå™¨çš„åœºæ™¯ã€‚\nä½†è¯·æ³¨æ„ï¼Œè¿™ä¸»è¦é€‚ç”¨äºè£¸æœºæœåŠ¡å™¨è€Œä¸é€‚ç”¨äºäº‘å®ä¾‹ã€‚\nå¦‚æœæ‚¨ä½¿ç”¨äº‘å®ä¾‹ï¼ˆä½œä¸ºæ‰˜ç®¡ Kubernetes æœåŠ¡çš„ä¸€éƒ¨åˆ†æˆ–åœ¨äº‘åŸºç¡€æ¶æ„ä¸Šå®‰è£…çš„ Kubernetesï¼‰ï¼Œåˆ™å®é™…ä¸Šæ˜¯å°†åº•å±‚æœºå™¨çš„ç®¡ç†å¤–åŒ…ç»™äº†äº‘æä¾›å•†ã€‚å› æ­¤ï¼Œç®¡ç†äº‘ä¸­çš„ 10 ä¸ªèŠ‚ç‚¹å¯èƒ½å¹¶ä¸æ¯”ç®¡ç†äº‘ä¸­çš„å•ä¸ªèŠ‚ç‚¹è€—è´¹æ›´å¤šç®¡ç†æˆæœ¬ã€‚\næ›´ä½çš„å•èŠ‚ç‚¹æˆæœ¬ è™½ç„¶é«˜ç«¯æœºå™¨æ¯”ä½ç«¯æœºå™¨æ›´æ˜‚è´µï¼Œä½†ä»·æ ¼ä¸Šæ¶¨ä¸ä¸€å®šæ˜¯çº¿æ€§çš„ã€‚æ¢å¥è¯è¯´ï¼Œå…·æœ‰ 10 ä¸ª CPU å’Œ 10GB å†…å­˜çš„å•å°æœºå™¨å¯èƒ½æ¯”å…·æœ‰ 1 ä¸ª CPU å’Œ 1GB å†…å­˜çš„ 10 å°æœºå™¨ä¾¿å®œã€‚\nä½†è¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨ä½¿ç”¨äº‘å®ä¾‹ï¼Œè¿™ä¸ªåŸåˆ™å¯èƒ½å¹¶ä¸é€‚ç”¨ã€‚\nåœ¨ä¸»è¦çš„äº‘æä¾›å•† Amazon Web Servicesã€Google Cloud Platform å’Œ Microsoft Azure çš„å½“å‰å®šä»·æ–¹æ¡ˆä¸­ï¼Œå®ä¾‹ä»·æ ¼ä¼šéšå®¹é‡çº¿æ€§å¢åŠ ã€‚ä¾‹å¦‚ï¼Œåœ¨ Google Cloud Platform ä¸Šï¼Œ64 ä¸ª n1-standard-1 å®ä¾‹çš„æˆæœ¬ä¸å•ä¸ª n1-standard-64 å®ä¾‹å®Œå…¨ç›¸åŒâ€”â€”è¿™ä¸¤ç§æ–¹å¼éƒ½ä¸ºæ‚¨æä¾› 64 ä¸ª CPU å’Œ 240GB å†…å­˜ã€‚å› æ­¤ï¼Œåœ¨äº‘ä¸Šï¼Œæ‚¨é€šå¸¸æ— æ³•é€šè¿‡ä½¿ç”¨æ›´å¤§çš„æœºå™¨æ¥èŠ‚çœèµ„é‡‘æŠ•å…¥ã€‚\nå¯è¿è¡Œé¥¥é¥¿å‹åº”ç”¨ å…·å¤‡å¤§å‹èŠ‚ç‚¹å¯èƒ½åªæ˜¯æ‚¨è¦åœ¨é›†ç¾¤ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºç±»å‹çš„éœ€æ±‚ã€‚\nä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æœ‰ä¸€ä¸ªéœ€è¦ 8GB å†…å­˜çš„æœºå™¨å­¦ä¹ åº”ç”¨ç¨‹åºï¼Œåˆ™æ— æ³•åœ¨ä»…å…·æœ‰ 1GB å†…å­˜çš„èŠ‚ç‚¹çš„é›†ç¾¤ä¸Šè¿è¡Œå®ƒã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥åœ¨å…·æœ‰ 10GB å†…å­˜èŠ‚ç‚¹çš„é›†ç¾¤ä¸Šè¿è¡Œå®ƒã€‚\nåŠ£åŠ¿ çœ‹å®Œäº†ä¼˜åŠ¿ï¼Œè®©æˆ‘ä»¬å†æ¥çœ‹çœ‹åŠ£åŠ¿ã€‚\nå•èŠ‚ç‚¹è¿è¡Œå¤§é‡ Pod åœ¨è¾ƒå°‘çš„èŠ‚ç‚¹ä¸Šè¿è¡Œç›¸åŒçš„å·¥ä½œè´Ÿè½½è‡ªç„¶æ„å‘³ç€åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œæ›´å¤šçš„ Podã€‚\nè¿™å¯èƒ½ä¼šæˆä¸ºä¸€ä¸ªé—®é¢˜ã€‚\nåŸå› æ˜¯æ¯ä¸ª Pod éƒ½ä¼šä¸ºåœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ Kubernetes ä»£ç†ç¨‹åºå¼•å…¥ä¸€äº›å¼€é”€â€”â€”ä¾‹å¦‚å®¹å™¨è¿è¡Œæ—¶ï¼ˆå¦‚ Dockerï¼‰ã€kubelet å’Œ cAdvisorã€‚\nä¾‹å¦‚ï¼Œkubelet å¯¹èŠ‚ç‚¹ä¸Šçš„æ¯ä¸ªå®¹å™¨æ‰§è¡Œå‘¨æœŸæ€§çš„ liveness å’Œ readiness æ¢æµ‹â€”â€”æ›´å¤šå®¹å™¨æ„å‘³ç€åœ¨æ¯è½®è¿­ä»£ä¸­ kubelet å°†æ‰§è¡Œæ›´å¤šå·¥ä½œã€‚cAdvisor æ”¶é›†èŠ‚ç‚¹ä¸Šæ‰€æœ‰å®¹å™¨çš„èµ„æºä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯ï¼Œå¹¶ä¸” kubelet å®šæœŸæŸ¥è¯¢æ­¤ä¿¡æ¯å¹¶åœ¨å…¶ API ä¸Šå…¬å¼€å®ƒâ€”â€”å†æ¬¡ï¼Œè¿™æ„å‘³ç€æ¯è½®è¿­ä»£ä¸­ cAdvisor å’Œ kubelet çš„å·¥ä½œé‡éƒ½ä¼šå¢åŠ ã€‚\néšç€ Pod æ•°é‡çš„å¢é•¿ï¼Œè¿™äº›é—®é¢˜çš„èšç§¯å¯èƒ½ä¼šå¼€å§‹å‡æ…¢ç³»ç»Ÿé€Ÿåº¦ï¼Œç”šè‡³ä½¿é›†ç¾¤ç³»ç»Ÿå˜å¾—ä¸å¯é ã€‚\n æœ‰æŠ¥å‘Šç§°ï¼ŒèŠ‚ç‚¹è¢«æŠ¥å‘Šä¸ºæœªå°±ç»ªï¼Œæ˜¯å› ä¸ºå‘¨æœŸæ€§çš„çš„ kubelet è¿è¡ŒçŠ¶å†µæ£€æŸ¥èŠ±è´¹äº†å¤ªé•¿æ—¶é—´æ¥è¿­ä»£èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰å®¹å™¨ã€‚\nå‡ºäºè¿™äº›åŸå› ï¼ŒKubernetes å®˜æ–¹å»ºè®®æ¯ä¸ªèŠ‚ç‚¹æœ€å¤š 110 ä¸ª Podã€‚å¯¹äºè¿™ä¸ªæ•°å­—ï¼ŒKubernetes å·²ç»è¿›è¡Œè¿‡ç›¸å…³æµ‹è¯•ï¼Œå¯ä»¥åœ¨ä¸€èˆ¬ç±»å‹çš„èŠ‚ç‚¹ä¸Šå¯é åœ°å·¥ä½œã€‚\nå½“ç„¶ï¼Œå¦‚æœèŠ‚ç‚¹çš„æ€§èƒ½è¶³å¤Ÿå¥½ï¼Œæ‚¨å¯èƒ½ä¹Ÿèƒ½å¤ŸæˆåŠŸåœ°è®©æ¯ä¸ªèŠ‚ç‚¹è¿è¡Œæ›´å¤šçš„ Pod â€”â€”ä½†å¾ˆéš¾é¢„æµ‹è¿™æ˜¯å¦èƒ½å¤Ÿé¡ºåˆ©è¿›è¡Œï¼Œä¹Ÿè®¸ä¼šé‡åˆ°ä¸€äº›é—®é¢˜ã€‚\nå¤§å¤šæ•°æ‰˜ç®¡ Kubernetes æœåŠ¡ç”šè‡³å¯¹æ¯ä¸ªèŠ‚ç‚¹çš„ Pod æ•°é‡æ–½åŠ äº†ä¸¥æ ¼çš„é™åˆ¶ï¼š\n åœ¨ Amazon Elastic Kubernetes Serviceï¼ˆEKSï¼‰ä¸Šï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„æœ€å¤§ Pod æ•°å–å†³äºèŠ‚ç‚¹ç±»å‹ï¼ŒèŒƒå›´ä» 4 åˆ° 737ã€‚ åœ¨ Google Kubernetes Engineï¼ˆGKEï¼‰ä¸Šï¼Œæ— è®ºèŠ‚ç‚¹ç±»å‹å¦‚ä½•ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„é™åˆ¶ä¸º 100 ä¸ª Podã€‚ åœ¨ Azure Kubernetes Serviceï¼ˆAKSï¼‰ä¸Šï¼Œé»˜è®¤é™åˆ¶æ˜¯æ¯ä¸ªèŠ‚ç‚¹ 30 ä¸ª Podï¼Œä½†æœ€å¤šå¯ä»¥å¢åŠ åˆ° 250 ä¸ªã€‚  å› æ­¤ï¼Œå¦‚æœæ‚¨è®¡åˆ’ä¸ºæ¯ä¸ªèŠ‚ç‚¹è¿è¡Œå¤§é‡ Podï¼Œåˆ™åº”è¯¥äº‹å…ˆè¿›è¡Œæµ‹è¯•ï¼Œçœ‹èƒ½å¦æŒ‰é¢„æœŸé‚£æ ·å·¥ä½œã€‚\næœ‰é™çš„å‰¯æœ¬æ•°é‡ è¾ƒå°‘çš„èŠ‚ç‚¹å¯èƒ½ä¼šé™åˆ¶åº”ç”¨ç¨‹åºçš„å‰¯æœ¬æ•°é‡ã€‚\nä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æœ‰ä¸€ä¸ªç”± 5 ä¸ªå‰¯æœ¬ç»„æˆçš„é«˜å¯ç”¨åº”ç”¨ç¨‹åºï¼Œä½†æ‚¨åªæœ‰ 2 ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆåº”ç”¨ç¨‹åºçš„æœ‰æ•ˆå‰¯æœ¬æ•°é‡å°†å‡å°‘åˆ° 2ã€‚è¿™æ˜¯å› ä¸º 5 ä¸ªå‰¯æœ¬åªèƒ½åˆ†å¸ƒåœ¨ 2 ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹å¤±è´¥ï¼Œå®ƒå¯èƒ½ä¼šåŒæ—¶æŒ‚æ‰è¯¥èŠ‚ç‚¹ä¸Šçš„å¤šä¸ªå‰¯æœ¬ã€‚ç›¸åï¼Œå¦‚æœæ‚¨æœ‰è‡³å°‘ 5 ä¸ªèŠ‚ç‚¹ï¼Œåˆ™æ¯ä¸ªå‰¯æœ¬å¯ä»¥åœ¨å•ç‹¬çš„èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œå¹¶ä¸”å•ä¸ªèŠ‚ç‚¹çš„æ•…éšœæœ€å¤šåªä¼šæŒ‚æ‰å…¶ä¸­ä¸€ä¸ªå‰¯æœ¬ã€‚\nå› æ­¤ï¼Œå¦‚æœæ‚¨æœ‰é«˜å¯ç”¨è¦æ±‚ï¼Œåˆ™å¯èƒ½éœ€è¦é›†ç¾¤èŠ‚ç‚¹æ•°å¤§äºæŸä¸ªä¸‹é™å€¼ã€‚\næ›´é«˜çš„çˆ†ç‚¸åŠå¾„ å¦‚æœæ‚¨åªæœ‰å‡ ä¸ªå·¥ä½œèŠ‚ç‚¹ï¼Œé‚£ä¹ˆèŠ‚ç‚¹å¤±è´¥é€ æˆçš„å½±å“æ¯”ä½¿ç”¨å¤§é‡èŠ‚ç‚¹æ—¶çš„å½±å“è¦å¤§ã€‚\nä¾‹å¦‚ï¼Œå¦‚æœæ‚¨åªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œé‚£å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œå°±æ„å‘³ç€ä¸€åŠçš„èŠ‚ç‚¹ä¼šæ¶ˆå¤±ã€‚Kubernetes å¯ä»¥å°†å¤±è´¥èŠ‚ç‚¹çš„å·¥ä½œè´Ÿè½½é‡æ–°å®‰æ’åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨åªæœ‰å‡ ä¸ªèŠ‚ç‚¹ï¼Œé‚£é£é™©ä¹Ÿä¼šå¢åŠ ï¼Œå› ä¸ºå‰©ä½™èŠ‚ç‚¹ä¸Šå¯èƒ½æ²¡æœ‰è¶³å¤Ÿçš„å¤‡ç”¨èµ„æºå®¹é‡æ¥å®¹çº³æ•…éšœèŠ‚ç‚¹çš„æ‰€æœ‰å·¥ä½œè´Ÿè½½ã€‚ç»“æœæ˜¯ï¼Œéƒ¨åˆ†åº”ç”¨ç¨‹åºå°†æ°¸ä¹…åœæœºï¼Œç›´åˆ°å†æ¬¡å¯åŠ¨æ•…éšœèŠ‚ç‚¹ã€‚\nå› æ­¤ï¼Œå¦‚æœæ‚¨æƒ³å‡å°‘ç¡¬ä»¶æ•…éšœçš„å½±å“ï¼Œåˆ™åº”è¯¥é€‰æ‹©æ›´å¤šçš„èŠ‚ç‚¹ã€‚\næ›´å¤§çš„èµ„æºä¼¸ç¼©å¢é‡ Kubernetes ä¸ºäº‘åŸºç¡€æ¶æ„æä¾›äº† Cluster Autoscalerï¼Œå…è®¸æ ¹æ®å½“å‰éœ€æ±‚è‡ªåŠ¨æ·»åŠ æˆ–åˆ é™¤èŠ‚ç‚¹ã€‚å¦‚æœä½¿ç”¨å¤§å‹èŠ‚ç‚¹ï¼Œåˆ™ä¼šæœ‰è¾ƒå¤§çš„èµ„æºä¼¸ç¼©å¢é‡ï¼Œè¿™ä¼šä½¿èµ„æºæ‰©ç¼©å®¹æ›´åŠ ç¬¨é‡ã€‚\nä¾‹å¦‚ï¼Œå¦‚æœæ‚¨åªæœ‰ 2 ä¸ªèŠ‚ç‚¹ï¼Œåˆ™æ·»åŠ èŠ‚ç‚¹æ„å‘³ç€å°†ç¾¤é›†å®¹é‡å¢åŠ  50%ã€‚è¿™å¯èƒ½æ¯”æ‚¨å®é™…éœ€è¦çš„èµ„æºå¤šå¾—å¤šï¼Œå°±æ„å‘³ç€æ‚¨éœ€è¦ä¸ºæœªä½¿ç”¨çš„èµ„æºä»˜è´¹ã€‚\nå› æ­¤ï¼Œå¦‚æœæ‚¨è®¡åˆ’ä½¿ç”¨é›†ç¾¤çš„è‡ªåŠ¨å¼¹æ€§ä¼¸ç¼©åŠŸèƒ½ï¼Œåˆ™è¾ƒå°çš„èŠ‚ç‚¹å…è®¸æ‚¨è¿›è¡Œæ›´è½»é‡ä¸”ç»æµé«˜æ•ˆçš„èµ„æºæ‰©ç¼©å®¹ã€‚\næ›´å¤šçš„ä½é…èŠ‚ç‚¹ åœ¨è®¨è®ºäº†æ›´å°‘é«˜é…èŠ‚ç‚¹çš„ä¼˜ç¼ºç‚¹ä¹‹åï¼Œè®©æˆ‘ä»¬è½¬å‘æ›´å¤šä½é…èŠ‚ç‚¹çš„åœºæ™¯ã€‚\nè¿™ç§æ–¹æ³•é€šè¿‡è®¸å¤šä½é…èŠ‚ç‚¹æ„å»ºé›†ç¾¤ï¼Œè€Œä¸ä½¿ç”¨æ›´å°‘çš„é«˜é…èŠ‚ç‚¹ã€‚\n*é‚£å®ƒçš„ä¼˜ç¼ºç‚¹åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ*\nä¼˜åŠ¿ ä½¿ç”¨æ›´å¤šä½é…èŠ‚ç‚¹çš„ä¼˜ç‚¹æ­£å¯¹åº”äºä½¿ç”¨æ›´å°‘é«˜é…èŠ‚ç‚¹çš„ç¼ºç‚¹ã€‚\nå‡å°‘çˆ†ç‚¸åŠå¾„ å¦‚æœæ‚¨æœ‰æ›´å¤šèŠ‚ç‚¹ï¼Œåˆ™æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ Pod è‡ªç„¶ä¼šæ›´å°‘ã€‚\nä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æœ‰ 100 ä¸ª Pod å’Œ 10 ä¸ªèŠ‚ç‚¹ï¼Œåˆ™æ¯ä¸ªèŠ‚ç‚¹å¹³å‡åªåŒ…å« 10 ä¸ª Podã€‚è¿™æ ·ï¼Œå³ä¾¿å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼Œå®ƒçš„å½±å“ä¹Ÿä»…é™äºæ€»å·¥ä½œè´Ÿè½½çš„è¾ƒå°çš„ä¸€éƒ¨åˆ†ã€‚æœ‰å¯èƒ½åªæœ‰éƒ¨åˆ†åº”ç”¨ç¨‹åºå—åˆ°å½±å“ï¼Œå¹¶ä¸”å¯èƒ½åªæœ‰å°‘é‡å‰¯æœ¬æŒ‚æ‰ï¼Œå› æ­¤æ•´ä¸ªåº”ç”¨ç¨‹åºä¼šä»ç„¶ä¿æŒè¿è¡ŒçŠ¶æ€ã€‚\næ­¤å¤–ï¼Œå‰©ä½™èŠ‚ç‚¹ä¸Šçš„å¤‡ç”¨èµ„æºå¾ˆå¯èƒ½è¶³ä»¥å®¹çº³æ•…éšœèŠ‚ç‚¹çš„å·¥ä½œè´Ÿè½½ï¼Œå› æ­¤Kubernetes å¯ä»¥é‡æ–°å®‰æ’æ‰€æœ‰ Podï¼Œå¹¶ä¸”æ‚¨çš„åº”ç”¨ç¨‹åºå¯ä»¥ç›¸å¯¹å¿«é€Ÿåœ°æ¢å¤åˆ°å®Œå…¨æ­£å¸¸çš„è¿è¡ŒçŠ¶æ€ã€‚\nå…è®¸æ›´å¤šå‰¯æœ¬ å¦‚æœæ‚¨æœ‰ä¸€ä¸ªå¤šå‰¯æœ¬é«˜å¯ç”¨åº”ç”¨ç¨‹åºä»¥åŠè¶³å¤Ÿçš„å¯ç”¨èŠ‚ç‚¹ï¼ŒKubernetes è°ƒåº¦ç¨‹åºå¯ä»¥å°†æ¯ä¸ªå‰¯æœ¬åˆ†é…ç»™ä¸åŒçš„èŠ‚ç‚¹ã€‚\n æ‚¨å¯ä»¥é€šè¿‡èŠ‚ç‚¹äº²å’Œã€Pod äº²å’Œ/åäº²å’Œä»¥åŠæ±¡ç‚¹å’Œå®¹å¿æ¥å½±å“è°ƒåº¦ç¨‹åºå¯¹ Pod çš„è°ƒåº¦ã€‚\n è¿™æ„å‘³ç€å¦‚æœæŸä¸ªèŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œåˆ™æœ€å¤šåªæœ‰ä¸€ä¸ªå‰¯æœ¬å—å½±å“ï¼Œä¸”æ‚¨çš„åº”ç”¨ç¨‹åºä»ç„¶å¯ç”¨ã€‚\nåŠ£åŠ¿ çœ‹äº†ä½¿ç”¨æ›´å¤šä½é…èŠ‚ç‚¹çš„ä¼˜ç‚¹ï¼Œé‚£å®ƒæœ‰ä»€ä¹ˆç¼ºç‚¹å‘¢ï¼Ÿ\nè¾ƒå¤§çš„èŠ‚ç‚¹æ•°é‡ å¦‚æœä½¿ç”¨è¾ƒå°çš„èŠ‚ç‚¹ï¼Œåˆ™è‡ªç„¶éœ€è¦æ›´å¤šèŠ‚ç‚¹æ¥å®ç°ç»™å®šçš„é›†ç¾¤å®¹é‡ã€‚\nä½†æ˜¯å¤§é‡èŠ‚ç‚¹å¯¹ Kubernetes æ§åˆ¶å¹³é¢æ¥è¯´å¯èƒ½æ˜¯ä¸€ä¸ªæŒ‘æˆ˜ã€‚\nä¾‹å¦‚ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦èƒ½å¤Ÿä¸å…¶ä»–èŠ‚ç‚¹é€šä¿¡ï¼Œè¿™ä½¿å¾—å¯èƒ½çš„é€šä¿¡è·¯å¾„æ•°é‡ä¼šæŒ‰ç…§èŠ‚ç‚¹æ•°é‡çš„å¹³æ–¹å¢é•¿â€”â€”æ‰€æœ‰èŠ‚ç‚¹éƒ½å¿…é¡»ç”±æ§åˆ¶å¹³é¢ç®¡ç†ã€‚\nKubernetes controller manager ä¸­çš„èŠ‚ç‚¹æ§åˆ¶å™¨å®šæœŸéå†é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ä»¥è¿è¡ŒçŠ¶å†µæ£€æŸ¥â€”â€”æ›´å¤šèŠ‚ç‚¹æ„å‘³ç€èŠ‚ç‚¹æ§åˆ¶å™¨çš„è´Ÿè½½æ›´å¤šã€‚\næ›´å¤šèŠ‚ç‚¹åŒæ—¶ä¹Ÿæ„å‘³ç€ etcd æ•°æ®åº“ä¸Šçš„è´Ÿè½½ä¹Ÿæ›´å¤šâ€”â€”æ¯ä¸ª kubelet å’Œ kube-proxy éƒ½ä¼šæˆä¸ºä¸€ä¸ª etcd çš„ watcher å®¢æˆ·ç«¯ï¼ˆé€šè¿‡ APIServerï¼‰ï¼Œetcd å¿…é¡»å¹¿æ’­å¯¹è±¡å˜åŒ–åˆ°è¿™äº›å®¢æˆ·ç«¯ã€‚\né€šå¸¸ï¼Œæ¯ä¸ªå·¥ä½œèŠ‚ç‚¹éƒ½ä¼šå¯¹ä¸»èŠ‚ç‚¹ä¸Šçš„ç³»ç»Ÿç»„ä»¶æ–½åŠ ä¸€äº›å¼€é”€ã€‚\n æ®å®˜æ–¹ç»Ÿè®¡ï¼ŒKubernetes å£°ç§°æ”¯æŒæœ€å¤š 5000 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ã€‚ç„¶è€Œï¼Œåœ¨å®è·µä¸­ï¼Œ500 ä¸ªèŠ‚ç‚¹å¯èƒ½å·²ç»å½¢æˆäº†å·¨å¤§çš„æŒ‘æˆ˜ã€‚\né€šè¿‡ä½¿ç”¨æ€§èƒ½æ›´é«˜çš„ä¸»èŠ‚ç‚¹ï¼Œå¾€å¾€å¯ä»¥å‡è½»å¤§é‡å·¥ä½œèŠ‚ç‚¹å¸¦æ¥çš„å½±å“ã€‚è¿™ä¹Ÿæ­£æ˜¯ç›®å‰åœ¨å®è·µä¸­æ‰€åº”ç”¨çš„â€”â€”è¿™é‡Œæ˜¯ kube-up åœ¨äº‘åŸºç¡€æ¶æ„ä¸Šä½¿ç”¨çš„ä¸»èŠ‚ç‚¹å¤§å°ï¼š\n Google Cloud Platform  5 ä¸ªå·¥ä½œèŠ‚ç‚¹ â†’ n1-standard-1 ä¸»èŠ‚ç‚¹ 500 ä¸ªå·¥ä½œèŠ‚ç‚¹ â†’ n1-standard-32 ä¸»èŠ‚ç‚¹   Amazon Web Services  5 ä¸ªå·¥ä½œèŠ‚ç‚¹ â†’ m3.medium ä¸»èŠ‚ç‚¹ 500 ä¸ªå·¥ä½œèŠ‚ç‚¹ â†’ c4.8xlarge ä¸»èŠ‚ç‚¹    å¦‚æ‚¨æ‰€è§ï¼Œå¯¹äº 500 ä¸ªå·¥ä½œèŠ‚ç‚¹ï¼Œä½¿ç”¨çš„ä¸»èŠ‚ç‚¹åˆ†åˆ«å…·æœ‰ 32 å’Œ 36 ä¸ª CPU ä»¥åŠ 120GB å’Œ 60GB å†…å­˜ã€‚\nè¿™äº›éƒ½æ˜¯ç›¸å½“å¤§çš„æœºå™¨ï¼\nå› æ­¤ï¼Œå¦‚æœæ‚¨æ‰“ç®—ä½¿ç”¨å¤§é‡ä½é…èŠ‚ç‚¹ï¼Œåˆ™éœ€è¦è®°ä½ä¸¤ä»¶äº‹ï¼š\n æ‚¨æ‹¥æœ‰çš„å·¥ä½œèŠ‚ç‚¹è¶Šå¤šï¼Œä¸»èŠ‚ç‚¹éœ€è¦çš„æ€§èƒ½å°±è¶Šé«˜ å¦‚æœæ‚¨è®¡åˆ’ä½¿ç”¨è¶…è¿‡ 500 ä¸ªèŠ‚ç‚¹ï¼Œåˆ™å¯èƒ½ä¼šé‡åˆ°ä¸€äº›éœ€è¦ä»˜å‡ºä¸€äº›åŠªåŠ›æ‰èƒ½è§£å†³çš„æ€§èƒ½ç“¶é¢ˆ   åƒ Virtual Kubelet è¿™æ ·çš„æ–°å¼€å‘äº§å“å…è®¸æ‚¨ç»•è¿‡è¿™äº›é™åˆ¶ï¼Œä»¥æ„å»ºå…·æœ‰å¤§é‡å·¥ä½œèŠ‚ç‚¹çš„é›†ç¾¤ã€‚\n æ›´å¤šçš„ç³»ç»Ÿå¼€é”€ Kubernetes åœ¨æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ç»„ç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹â€”â€”åŒ…æ‹¬å®¹å™¨è¿è¡Œæ—¶ï¼ˆå¦‚ Dockerï¼‰ã€kube-proxy å’ŒåŒ…å« cAdvisor çš„ kubeletã€‚\n cAdvisor åŒ…å«åœ¨ kubelet äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚\n æ‰€æœ‰è¿™äº›å®ˆæŠ¤è¿›ç¨‹ä¸€èµ·æ¶ˆè€—å›ºå®šæ•°é‡çš„èµ„æºã€‚\nå¦‚æœä½¿ç”¨è®¸å¤šä½é…èŠ‚ç‚¹ï¼Œåˆ™è¿™äº›ç³»ç»Ÿç»„ä»¶æ¶ˆè€—çš„èµ„æºå æ¯”ä¼šå¢å¤§ã€‚\nä¾‹å¦‚ï¼Œå‡è®¾å•ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰ç³»ç»Ÿå®ˆæŠ¤ç¨‹åºä¸€èµ·ä½¿ç”¨ 0.1 ä¸ª CPU å’Œ 0.1GB å†…å­˜ã€‚å¦‚æœæ‚¨æ‹¥æœ‰ 10 ä¸ª CPU å’Œ 10GB å†…å­˜çš„å•ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆå®ˆæŠ¤ç¨‹åºå°†å ç”¨é›†ç¾¤å®¹é‡çš„ 1%ã€‚è€Œå¦‚æœæ‚¨æœ‰ 1 ä¸ª CPU å’Œ 1GB å†…å­˜çš„ 10 ä¸ªèŠ‚ç‚¹ï¼Œåˆ™åå°ç¨‹åºå°†å ç”¨é›†ç¾¤å®¹é‡çš„ 10%ã€‚åœ¨ç¬¬äºŒç§æƒ…å†µä¸‹ï¼Œ10% çš„èµ„æºæ¶ˆè€—ç”¨äºè¿è¡Œç³»ç»Ÿï¼Œè€Œåœ¨ç¬¬ä¸€ç§æƒ…å†µä¸‹ï¼Œå®ƒåªå  1%ã€‚\nå› æ­¤ï¼Œå¦‚æœæ‚¨å¸Œæœ›æœ€å¤§åŒ–åŸºç¡€æ¶æ„æ”¯å‡ºçš„å›æŠ¥ï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½ä¼šå–œæ¬¢æ›´å°‘çš„èŠ‚ç‚¹ã€‚\næ›´ä½çš„èµ„æºåˆ©ç”¨ç‡ å¦‚æœæ‚¨ä½¿ç”¨è¾ƒå°çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šäº§ç”Ÿå¤§é‡èµ„æºç¢ç‰‡å› èµ„æºå¤ªå°‘è€Œæ— æ³•åˆ†é…ç»™ä»»ä½•å·¥ä½œè´Ÿè½½ï¼Œæœ€ç»ˆä¿æŒæœªä½¿ç”¨çŠ¶æ€ã€‚\nä¾‹å¦‚ï¼Œå‡è®¾æ‚¨çš„æ‰€æœ‰ Pod éƒ½éœ€è¦ 0.75GB çš„å†…å­˜ã€‚å¦‚æœæ‚¨æœ‰ 10 ä¸ª 1GB å†…å­˜çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæœ€å¤šå¯ä»¥è¿è¡Œ 10 ä¸ªè¿™æ ·çš„ Podâ€”â€”æ‚¨æœ€ç»ˆä¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šæœ‰ä¸€å— 0.25GB çš„å†…å­˜ä¸èƒ½ä½¿ç”¨ã€‚è¿™æ„å‘³ç€ï¼Œé›†ç¾¤æ€»å†…å­˜çš„ 25% è¢«æµªè´¹äº†ã€‚ç›¸åï¼Œå¦‚æœæ‚¨ä½¿ç”¨å…·æœ‰ 10GB å†…å­˜çš„å•ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥è¿è¡Œ 13 ä¸ª Pod â€”â€”æ‚¨æœ€ç»ˆä¼šåœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šæœ‰ä¸€å— 0.25GB çš„å†…å­˜ä¸èƒ½ä½¿ç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨åªä¼šæµªè´¹ 2.5% çš„å†…å­˜ã€‚\nå› æ­¤ï¼Œå¦‚æœæ‚¨æƒ³æœ€å¤§é™åº¦åœ°å‡å°‘èµ„æºæµªè´¹ï¼Œä½¿ç”¨æ›´å¤§çš„èŠ‚ç‚¹å¯èƒ½ä¼šå¸¦æ¥æ›´å¥½çš„ç»“æœã€‚\nPod è¿è¡Œæ•°é‡é™åˆ¶ åœ¨æŸäº›äº‘åŸºç¡€æ¶æ„ä¸Šï¼Œä½é…èŠ‚ç‚¹ä¸Šå…è®¸çš„æœ€å¤§ Pod æ•°é‡æ¯”æ‚¨é¢„æœŸçš„è¦é™åˆ¶å¾—æ›´å¤šã€‚\nAmazon Elastic Kubernetes Serviceï¼ˆEKSï¼‰å°±æ˜¯è¿™ç§æƒ…å†µï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„æœ€å¤§ Pod æ•°å–å†³äºå®ä¾‹ç±»å‹ã€‚\nä¾‹å¦‚ï¼Œå¯¹äº t2.medium å®ä¾‹ï¼Œæœ€å¤§ Pod æ•°ä¸º 17ï¼Œt2.small ä¸º 11ï¼Œè€Œ t2.microä¸º 4ã€‚\nè¿™äº›éƒ½æ˜¯éå¸¸å°çš„æ•°å­—ï¼\nä»»ä½•è¶…å‡ºè¿™äº›é™åˆ¶çš„ Pod éƒ½æ— æ³•ç”± Kubernetes è°ƒåº¦ï¼Œå¹¶è¢«æ— é™æœŸåœ°ä¿æŒåœ¨ Pending çŠ¶æ€ã€‚\nå¦‚æœæ‚¨ä¸äº†è§£è¿™äº›é™åˆ¶ï¼Œåˆ™å¯èƒ½å¯¼è‡´éš¾ä»¥å‘ç°çš„é”™è¯¯ã€‚\nå› æ­¤ï¼Œå¦‚æœæ‚¨è®¡åˆ’åœ¨ Amazon EKS ä¸Šä½¿ç”¨ä½é…èŠ‚ç‚¹ï¼Œè¯·æ£€æŸ¥ç›¸åº”çš„æ¯èŠ‚ç‚¹ Pod æ•°é‡é™åˆ¶ï¼Œå¹¶è®¡ç®—èŠ‚ç‚¹æ˜¯å¦å¯ä»¥å®¹çº³æ‰€æœ‰ Podã€‚\nç»“è®º é‚£ä¹ˆï¼Œæ‚¨åº”è¯¥åœ¨é›†ç¾¤ä¸­ä½¿ç”¨æ›´å°‘çš„é«˜é…èŠ‚ç‚¹è¿˜æ˜¯æ›´å¤šçš„ä½é…èŠ‚ç‚¹å‘¢ï¼Ÿ\nè¿™æ²¡æœ‰æ˜ç¡®çš„ç­”æ¡ˆã€‚\næ‚¨è¦éƒ¨ç½²åˆ°é›†ç¾¤çš„åº”ç”¨ç¨‹åºç±»å‹å¯èƒ½ä¼šå½±å“æ‚¨çš„å†³ç­–ã€‚\nä¾‹å¦‚ï¼Œå¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºéœ€è¦ 10GB å†…å­˜ï¼Œåˆ™å¯èƒ½ä¸åº”ä½¿ç”¨ä½é…èŠ‚ç‚¹â€”â€”é›†ç¾¤ä¸­çš„èŠ‚ç‚¹åº”è‡³å°‘å…·æœ‰ 10GB å†…å­˜ã€‚æˆ–è€…ï¼Œå¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºéœ€è¦ 10 å‰¯æœ¬ä»¥å®ç°é«˜å¯ç”¨ï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½ä¸åº”è¯¥åªä½¿ç”¨ 2 ä¸ªèŠ‚ç‚¹â€”â€”æ‚¨çš„é›†ç¾¤åº”è¯¥è‡³å°‘æœ‰ 10 ä¸ªèŠ‚ç‚¹ã€‚\nå¯¹äºä¸­é—´çš„æ‰€æœ‰åœºæ™¯ï¼Œå®ƒå–å†³äºæ‚¨çš„å…·ä½“éœ€æ±‚ã€‚\nä»¥ä¸Šå“ªé¡¹ä¼˜ç¼ºç‚¹ä¸æ‚¨ç›¸å…³ï¼Ÿå“ªé¡¹ä¸æ‚¨ä¸ç›¸å…³ï¼Ÿ\nè¯è™½å¦‚æ­¤ï¼Œä½†æ²¡æœ‰è§„åˆ™è¯´æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»å…·æœ‰ç›¸åŒçš„å¤§å°ã€‚æ²¡æœ‰ä»€ä¹ˆèƒ½é˜»æ­¢æ‚¨ä½¿ç”¨ä¸åŒå¤§å°çš„èŠ‚ç‚¹æ¥æ··åˆæ„å»ºé›†ç¾¤ã€‚Kubernetes é›†ç¾¤çš„å·¥ä½œèŠ‚ç‚¹å¯ä»¥æ˜¯å®Œå…¨å¼‚æ„çš„ã€‚è¿™å¯èƒ½ä¼šè®©æ‚¨æƒè¡¡ä¸¤ç§æ–¹æ³•çš„ä¼˜ç¼ºç‚¹ã€‚\næœ€åï¼Œå®è·µæ˜¯æ£€éªŒçœŸç†çš„å”¯ä¸€æ ‡å‡†â€”â€”æœ€å¥½çš„æ–¹æ³•æ˜¯åå¤è¯•éªŒå¹¶æ‰¾åˆ°æœ€é€‚åˆæ‚¨çš„èµ„æºé…ç½®ç»„åˆï¼\n","permalink":"https://srcio.cn/posts/k8s-node-resource-config/","summary":"æ–‡ç« è½¬è½½è‡ªï¼šhttps://sataqiu.github.io/2019/09/09/architecting-kubernetes-clu","title":"K8s é›†ç¾¤è§„åˆ’ä¹‹èŠ‚ç‚¹èµ„æºé…ç½®"},{"content":" æ–‡ç« è½¬è½½è‡ªï¼šhttps://sataqiu.github.io/2019/07/15/k8s-kubelet-gc/index.html\n Kubelet åƒåœ¾å›æ”¶ï¼ˆGarbage Collectionï¼‰æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå®ƒè´Ÿè´£è‡ªåŠ¨æ¸…ç†èŠ‚ç‚¹ä¸Šçš„æ— ç”¨é•œåƒå’Œå®¹å™¨ã€‚Kubelet æ¯éš” 1 åˆ†é’Ÿè¿›è¡Œä¸€æ¬¡å®¹å™¨æ¸…ç†ï¼Œæ¯éš” 5 åˆ†é’Ÿè¿›è¡Œä¸€æ¬¡é•œåƒæ¸…ç†ï¼ˆæˆªæ­¢åˆ° v1.15 ç‰ˆæœ¬ï¼Œåƒåœ¾å›æ”¶é—´éš”æ—¶é—´è¿˜éƒ½æ˜¯åœ¨æºç ä¸­å›ºåŒ–çš„ï¼Œä¸å¯è‡ªå®šä¹‰é…ç½®ï¼‰ã€‚å¦‚æœèŠ‚ç‚¹ä¸Šå·²ç»è¿è¡Œäº† Kubeletï¼Œä¸å»ºè®®å†é¢å¤–è¿è¡Œå…¶å®ƒçš„åƒåœ¾å›æ”¶å·¥å…·ï¼Œå› ä¸ºè¿™äº›å·¥å…·å¯èƒ½é”™è¯¯åœ°æ¸…ç†æ‰ Kubelet è®¤ä¸ºæœ¬åº”ä¿ç•™çš„é•œåƒæˆ–å®¹å™¨ï¼Œä»è€Œå¯èƒ½é€ æˆä¸å¯é¢„çŸ¥çš„é—®é¢˜ã€‚\né•œåƒå›æ”¶ Kubernetes å¯¹èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰é•œåƒæä¾›ç”Ÿå‘½å‘¨æœŸç®¡ç†æœåŠ¡ï¼Œè¿™é‡Œçš„ã€æ‰€æœ‰é•œåƒã€æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„æ‰€æœ‰é•œåƒï¼Œè€Œä¸ä»…ä»…æ˜¯é€šè¿‡ Kubelet æ‹‰å–çš„é•œåƒã€‚å½“ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡è®¾å®šä¸Šé™ï¼ˆHighThresholdPercentï¼‰æ—¶ï¼ŒKubelet å°±ä¼šæŒ‰ç…§ LRU æ¸…é™¤ç­–ç•¥é€ä¸ªæ¸…ç†æ‰é‚£äº›æ²¡æœ‰è¢«ä»»ä½• Pod å®¹å™¨ï¼ˆåŒ…æ‹¬é‚£äº›å·²ç»æ­»äº¡çš„å®¹å™¨ï¼‰æ‰€ä½¿ç”¨çš„é•œåƒï¼Œç›´åˆ°ç£ç›˜ä½¿ç”¨ç‡é™åˆ°è®¾å®šä¸‹é™ï¼ˆLowThresholdPercentï¼‰æˆ–æ²¡æœ‰ç©ºé—²é•œåƒå¯ä»¥æ¸…ç†ã€‚æ­¤å¤–ï¼Œåœ¨è¿›è¡Œé•œåƒæ¸…ç†æ—¶ï¼Œä¼šè€ƒè™‘é•œåƒçš„ç”Ÿå­˜å¹´é¾„ï¼Œå¯¹äºå¹´é¾„æ²¡æœ‰è¾¾åˆ°æœ€çŸ­ç”Ÿå­˜å¹´é¾„ï¼ˆMinAgeï¼‰è¦æ±‚çš„é•œåƒï¼Œæš‚ä¸äºˆä»¥æ¸…ç†ã€‚\nä¸»ä½“æµç¨‹  å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒKubelet å¯¹äºèŠ‚ç‚¹ä¸Šé•œåƒçš„å›æ”¶æµç¨‹è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œåœ¨ç£ç›˜ä½¿ç”¨ç‡è¶…å‡ºè®¾å®šä¸Šé™åï¼šé¦–å…ˆï¼Œé€šè¿‡ CRI å®¹å™¨è¿è¡Œæ—¶æ¥å£è¯»å–èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰é•œåƒä»¥åŠ Pod å®¹å™¨ï¼›ç„¶åï¼Œæ ¹æ®ç°æœ‰å®¹å™¨åˆ—è¡¨è¿‡æ»¤å‡ºé‚£äº›å·²ç»ä¸è¢«ä»»ä½•å®¹å™¨æ‰€ä½¿ç”¨çš„é•œåƒï¼›æ¥ç€ï¼ŒæŒ‰ç…§é•œåƒæœ€è¿‘è¢«ä½¿ç”¨æ—¶é—´æ’åºï¼Œè¶Šä¹…è¢«ç”¨åˆ°çš„é•œåƒè¶Šä¼šè¢«æ’åœ¨å‰é¢ï¼Œä¼˜å…ˆæ¸…ç†ï¼›æœ€åï¼Œå°±æŒ‰ç…§æ’å¥½çš„é¡ºåºé€ä¸ªæ¸…ç†é•œåƒï¼Œç›´åˆ°ç£ç›˜ä½¿ç”¨ç‡é™åˆ°è®¾å®šä¸‹é™ï¼ˆæˆ–è€…å·²ç»æ²¡æœ‰ç©ºé—²é•œåƒå¯ä»¥æ¸…ç†ï¼‰ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒKubelet è¯»å–åˆ°çš„é•œåƒåˆ—è¡¨æ˜¯èŠ‚ç‚¹é•œåƒåˆ—è¡¨ï¼Œè€Œè¯»å–åˆ°çš„å®¹å™¨åˆ—è¡¨å´ä»…åŒ…æ‹¬ç”±å…¶ç®¡ç†çš„å®¹å™¨ï¼ˆå³ Pod å®¹å™¨ï¼ŒåŒ…æ‹¬ Pod å†…çš„æ­»äº¡å®¹å™¨ï¼‰ã€‚å› æ­¤ï¼Œé‚£äº›ç”¨æˆ·æ‰‹åŠ¨ run èµ·æ¥çš„å®¹å™¨ï¼Œå¯¹äº Kubelet åƒåœ¾å›æ”¶æ¥è¯´å°±æ˜¯ä¸å¯è§çš„ï¼Œä¹Ÿå°±ä¸èƒ½é˜»æ­¢å¯¹ç›¸å…³é•œåƒçš„åƒåœ¾å›æ”¶ã€‚å½“ç„¶ï¼ŒKubelet çš„é•œåƒå›æ”¶ä¸æ˜¯ force ç±»å‹çš„å›æ”¶ï¼Œè™½ç„¶ä¼šå¯¹ç”¨æˆ·æ‰‹åŠ¨ä¸‹è½½çš„é•œåƒè¿›è¡Œå›æ”¶åŠ¨ä½œï¼Œä½†å¦‚æœç¡®å®æœ‰è¿è¡Œçš„ï¼ˆæˆ–è€…åœæ­¢çš„ä»»ä½•ï¼‰å®¹å™¨ä¸è¯¥é•œåƒå…³è”çš„è¯ï¼Œåˆ é™¤æ“ä½œå°±ä¼šå¤±è´¥ï¼ˆè¢«åº•å±‚å®¹å™¨è¿è¡Œæ—¶é˜»æ­¢åˆ é™¤ï¼‰ã€‚\nç”¨æˆ·é…ç½® é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“å½±å“é•œåƒåƒåœ¾å›æ”¶çš„å…³é”®å‚æ•°æœ‰ï¼š\n image-gc-high-thresholdï¼šç£ç›˜ä½¿ç”¨ç‡ä¸Šé™ï¼Œæœ‰æ•ˆèŒƒå›´ [0-100]ï¼Œé»˜è®¤ 85 image-gc-low-thresholdï¼šç£ç›˜ä½¿ç”¨ç‡ä¸‹é™ï¼Œæœ‰æ•ˆèŒƒå›´ [0-100]ï¼Œé»˜è®¤ 80 minimum-image-ttl-durationï¼šé•œåƒæœ€çŸ­åº”è¯¥ç”Ÿå­˜çš„å¹´é¾„ï¼Œé»˜è®¤ 2 åˆ†é’Ÿ  å®éªŒç¯èŠ‚ æœ¬èŠ‚æˆ‘ä»¬é€šè¿‡å®éªŒæ¥éªŒè¯é•œåƒåƒåœ¾å›æ”¶ï¼ˆåŸºäº Kubelet 1.15 ç‰ˆæœ¬ï¼‰ã€‚\nå®éªŒå‰ï¼Œéœ€è¦é…ç½® Kubelet å¯åŠ¨å‚æ•°ï¼Œé™ä½ç£ç›˜ä½¿ç”¨ç‡ä¸Šé™ï¼Œä»¥ä¾¿èƒ½å¤Ÿç›´æ¥è§¦å‘é•œåƒå›æ”¶ã€‚\n# vim /etc/systemd/system/kubelet.service.d/10-kubeadm.conf ... ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS --image-gc-high-threshold=2 --image-gc-low-threshold=1 ... æˆ‘ä»¬åœ¨ Kubelet å¯åŠ¨å‚æ•°çš„æœ€åè¿½åŠ äº† --image-gc-high-threshold=2 --image-gc-low-threshold=1ï¼Œè¿™ä¹ˆä½çš„é…ç½®ï¼ŒKubelet åº”è¯¥ä¼šä¸€ç›´å¿™äºè¿›è¡Œé•œåƒå›æ”¶äº†ï¼Œç”Ÿäº§ç¯å¢ƒå¯ä¸èƒ½è¿™ä¹ˆé…ç½®ï¼\næ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä½¿å¾—é…ç½®ç”Ÿæ•ˆï¼š\n# systemctl daemon-reload # systemctl restart kubelet é¦–å…ˆï¼Œçœ‹ä¸‹æœ¬åœ°éƒ½æœ‰å“ªäº›é•œåƒï¼š\nroot@shida-machine:~# docker images REPOSITORY TAG IMAGE ID CREATED SIZE k8s.gcr.io/kube-proxy v1.14.4 5f2081c22306 6 days ago 82.1MB k8s.gcr.io/kube-apiserver v1.14.4 f3171d49fa9b 6 days ago 210MB k8s.gcr.io/kube-controller-manager v1.14.4 35f0904dc8fa 6 days ago 158MB k8s.gcr.io/kube-scheduler v1.14.4 ee080c083e45 6 days ago 81.6MB calico/node v3.7.3 bf4ff15c9db0 4 weeks ago 156MB calico/cni v3.7.3 1a6ade52d471 4 weeks ago 135MB calico/kube-controllers v3.7.3 283860d96794 4 weeks ago 46.8MB k8s.gcr.io/coredns 1.3.1 eb516548c180 6 months ago 40.3MB k8s.gcr.io/etcd 3.3.10 2c4adeb21b4f 7 months ago 258MB k8s.gcr.io/pause 3.1 da86e6ba6ca1 19 months ago 742kB æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿è¡Œä¸€ä¸ª nginx ç¨‹åºï¼Œè®© Kubelet è‡ªåŠ¨æ‹‰å–é•œåƒã€‚\nroot@shida-machine:~# kubectl run nginx --image=nginx deployment.apps/nginx created root@shida-machine:~# kubectl get deployment NAME READY UP-TO-DATE AVAILABLE AGE nginx 1/1 1 1 62s root@shida-machine:~# docker images REPOSITORY TAG IMAGE ID CREATED SIZE k8s.gcr.io/kube-proxy v1.14.4 5f2081c22306 6 days ago 82.1MB k8s.gcr.io/kube-controller-manager v1.14.4 35f0904dc8fa 6 days ago 158MB k8s.gcr.io/kube-apiserver v1.14.4 f3171d49fa9b 6 days ago 210MB k8s.gcr.io/kube-scheduler v1.14.4 ee080c083e45 6 days ago 81.6MB nginx latest f68d6e55e065 12 days ago 109MB calico/node v3.7.3 bf4ff15c9db0 4 weeks ago 156MB calico/cni v3.7.3 1a6ade52d471 4 weeks ago 135MB calico/kube-controllers v3.7.3 283860d96794 4 weeks ago 46.8MB k8s.gcr.io/coredns 1.3.1 eb516548c180 6 months ago 40.3MB k8s.gcr.io/etcd 3.3.10 2c4adeb21b4f 7 months ago 258MB k8s.gcr.io/pause 3.1 da86e6ba6ca1 19 months ago 742kB å¯ä»¥çœ‹åˆ°ï¼Œnginx é•œåƒå·²ç»è¢«è‡ªåŠ¨ pull åˆ°æœ¬åœ°äº†ï¼ŒID ä¸º f68d6e55e065ã€‚\nç„¶åï¼Œåˆ é™¤ nginx Deploymentï¼š\nroot@shida-machine:~# kubectl delete deployment nginx deployment.extensions \u0026quot;nginx\u0026quot; deleted è¿‡å¤§æ¦‚ 5 åˆ†é’Ÿåï¼Œå†æ¬¡æ£€æŸ¥æœ¬åœ°é•œåƒåˆ—è¡¨ï¼Œå‘ç° nginx é•œåƒå·²è¢«æ¸…ç†ï¼\nroot@shida-machine:~# docker images REPOSITORY TAG IMAGE ID CREATED SIZE k8s.gcr.io/kube-proxy v1.14.4 5f2081c22306 6 days ago 82.1MB k8s.gcr.io/kube-controller-manager v1.14.4 35f0904dc8fa 6 days ago 158MB k8s.gcr.io/kube-apiserver v1.14.4 f3171d49fa9b 6 days ago 210MB k8s.gcr.io/kube-scheduler v1.14.4 ee080c083e45 6 days ago 81.6MB calico/node v3.7.3 bf4ff15c9db0 4 weeks ago 156MB calico/cni v3.7.3 1a6ade52d471 4 weeks ago 135MB calico/kube-controllers v3.7.3 283860d96794 4 weeks ago 46.8MB k8s.gcr.io/coredns 1.3.1 eb516548c180 6 months ago 40.3MB k8s.gcr.io/etcd 3.3.10 2c4adeb21b4f 7 months ago 258MB k8s.gcr.io/pause 3.1 da86e6ba6ca1 19 months ago 742kB é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹é•œåƒåƒåœ¾å›æ”¶æ—¥å¿—ï¼š\nroot@shida-machine:~# journalctl -u kubelet -o cat | grep imageGCManager ... I0714 18:03:20.883489 51179 image_gc_manager.go:300] [imageGCManager]: Disk usage on image filesystem is at 24% which is over the high threshold (2%). Trying to free 72470076620 bytes down to the low threshold (1%). I0714 18:03:20.899370 51179 image_gc_manager.go:371] [imageGCManager]: Removing image \u0026quot;sha256:f68d6e55e06520f152403e6d96d0de5c9790a89b4cfc99f4626f68146fa1dbdc\u0026quot; to free 109357355 bytes å¯ä»¥çœ‹åˆ°ï¼Œæ—¥å¿—ä¸­è®°å½•çš„åˆ é™¤é•œåƒ ID ä¸ nginx é•œåƒçš„ ID æ˜¯ä¸€è‡´çš„ï¼ˆå‡ä¸º f68d6e55e065ï¼‰ã€‚\nç»§ç»­éªŒè¯ç”¨æˆ·æ‰‹åŠ¨æ‹‰å–çš„é•œåƒæ˜¯å¦ä¼šè¢«æ¸…ç†ï¼Œæ‰‹åŠ¨è¿è¡Œ nginx ç¨‹åºï¼š\nroot@shida-machine:~# docker run --name nginx -d nginx Unable to find image 'nginx:latest' locally latest: Pulling from library/nginx fc7181108d40: Pull complete d2e987ca2267: Pull complete 0b760b431b11: Pull complete Digest: sha256:48cbeee0cb0a3b5e885e36222f969e0a2f41819a68e07aeb6631ca7cb356fed1 Status: Downloaded newer image for nginx:latest 2fc8a836ba3c7cbd488c7fd4f2ffa7287b709abf1b7701685291c3b1e5df3472 é€šè¿‡æŸ¥çœ‹é•œåƒ GC æ—¥å¿—ï¼Œä¼šå‘ç° GC ä¼šå°è¯•æ¸…ç†ç”¨æˆ·è‡ªå·±æ‰‹åŠ¨æ‹‰å–çš„ nginx é•œåƒï¼Œä½†å› ä¸ºè¯¥é•œåƒè¢«ä½¿ç”¨ä¸­ï¼Œæ‰€ä»¥è¿™æ¬¡åˆ é™¤æ“ä½œä¸ä¼šæˆåŠŸï¼š\nroot@shida-machine:~# journalctl -u kubelet -o cat | grep imageGCManager ... I0714 18:28:23.015586 51179 image_gc_manager.go:300] [imageGCManager]: Disk usage on image filesystem is at 24% which is over the high threshold (2%). Trying to free 72501525708 bytes down to the low threshold (1%). I0714 18:28:23.306696 51179 image_gc_manager.go:371] [imageGCManager]: Removing image \u0026quot;sha256:f68d6e55e06520f152403e6d96d0de5c9790a89b4cfc99f4626f68146fa1dbdc\u0026quot; to free 109357355 bytes root@shida-machine:~# docker images REPOSITORY TAG IMAGE ID CREATED SIZE k8s.gcr.io/kube-proxy v1.14.4 5f2081c22306 6 days ago 82.1MB k8s.gcr.io/kube-apiserver v1.14.4 f3171d49fa9b 6 days ago 210MB k8s.gcr.io/kube-controller-manager v1.14.4 35f0904dc8fa 6 days ago 158MB k8s.gcr.io/kube-scheduler v1.14.4 ee080c083e45 6 days ago 81.6MB nginx latest f68d6e55e065 12 days ago 109MB calico/node v3.7.3 bf4ff15c9db0 4 weeks ago 156MB calico/cni v3.7.3 1a6ade52d471 4 weeks ago 135MB calico/kube-controllers v3.7.3 283860d96794 4 weeks ago 46.8MB k8s.gcr.io/coredns 1.3.1 eb516548c180 6 months ago 40.3MB k8s.gcr.io/etcd 3.3.10 2c4adeb21b4f 7 months ago 258MB k8s.gcr.io/pause 3.1 da86e6ba6ca1 19 months ago 742kB å°†è¯¥å®¹å™¨åœæ­¢ï¼Œç»§ç»­è§‚å¯Ÿå›æ”¶åŠ¨ä½œï¼š\nroot@shida-machine:~# docker stop nginx nginx root@shida-machine:~# journalctl -u kubelet -o cat | grep imageGCManager ... I0714 18:53:23.579629 51179 image_gc_manager.go:300] [imageGCManager]: Disk usage on image filesystem is at 24% which is over the high threshold (2%). Trying to free 72549280972 bytes down to the low threshold (1%). I0714 18:53:23.629492 51179 image_gc_manager.go:371] [imageGCManager]: Removing image \u0026quot;sha256:f68d6e55e06520f152403e6d96d0de5c9790a89b4cfc99f4626f68146fa1dbdc\u0026quot; to free 109357355 bytes root@shida-machine:~# docker images REPOSITORY TAG IMAGE ID CREATED SIZE k8s.gcr.io/kube-proxy v1.14.4 5f2081c22306 6 days ago 82.1MB k8s.gcr.io/kube-controller-manager v1.14.4 35f0904dc8fa 6 days ago 158MB k8s.gcr.io/kube-apiserver v1.14.4 f3171d49fa9b 6 days ago 210MB k8s.gcr.io/kube-scheduler v1.14.4 ee080c083e45 6 days ago 81.6MB nginx latest f68d6e55e065 12 days ago 109MB calico/node v3.7.3 bf4ff15c9db0 4 weeks ago 156MB calico/cni v3.7.3 1a6ade52d471 4 weeks ago 135MB calico/kube-controllers v3.7.3 283860d96794 4 weeks ago 46.8MB k8s.gcr.io/coredns 1.3.1 eb516548c180 6 months ago 40.3MB k8s.gcr.io/etcd 3.3.10 2c4adeb21b4f 7 months ago 258MB k8s.gcr.io/pause 3.1 da86e6ba6ca1 19 months ago 742kB å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºå·²ç»åœæ­¢çš„å®¹å™¨ï¼ŒKubelet ä¹Ÿæ˜¯ä¼šå°è¯•åˆ é™¤ï¼Œä½†åˆ é™¤æ“ä½œä¾ç„¶ä¸ä¼šæˆåŠŸï¼ˆå­˜åœ¨æ­»äº¡å®¹å™¨å¯¹è¯¥é•œåƒçš„å¼•ç”¨ï¼‰ã€‚\nå½»åº•åˆ é™¤ nginx å®¹å™¨ï¼Œæ­¤æ—¶å°±æ²¡æœ‰ä»»ä½•å®¹å™¨ç»§ç»­ä½¿ç”¨è¯¥é•œåƒï¼Œç»è¿‡ 1 æ¬¡ GC åï¼Œnginx é•œåƒå°±ä¼šè¢«æ¸…ç†ã€‚\nroot@shida-machine:~# docker rm nginx nginx root@shida-machine:~# docker images REPOSITORY TAG IMAGE ID CREATED SIZE k8s.gcr.io/kube-proxy v1.14.4 5f2081c22306 6 days ago 82.1MB k8s.gcr.io/kube-apiserver v1.14.4 f3171d49fa9b 6 days ago 210MB k8s.gcr.io/kube-controller-manager v1.14.4 35f0904dc8fa 6 days ago 158MB k8s.gcr.io/kube-scheduler v1.14.4 ee080c083e45 6 days ago 81.6MB calico/node v3.7.3 bf4ff15c9db0 4 weeks ago 156MB calico/cni v3.7.3 1a6ade52d471 4 weeks ago 135MB calico/kube-controllers v3.7.3 283860d96794 4 weeks ago 46.8MB k8s.gcr.io/coredns 1.3.1 eb516548c180 6 months ago 40.3MB k8s.gcr.io/etcd 3.3.10 2c4adeb21b4f 7 months ago 258MB k8s.gcr.io/pause 3.1 da86e6ba6ca1 19 months ago 742kB å®¹å™¨å›æ”¶ äº†è§£äº†é•œåƒå›æ”¶çš„åŸºæœ¬åŸç†ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å®¹å™¨å›æ”¶ã€‚å®¹å™¨åœ¨åœæ­¢è¿è¡Œï¼ˆæ¯”å¦‚å‡ºé”™é€€å‡ºæˆ–è€…æ­£å¸¸ç»“æŸï¼‰åä¼šæ®‹ç•™ä¸€ç³»åˆ—çš„åƒåœ¾æ–‡ä»¶ï¼Œä¸€æ–¹é¢ä¼šå æ®ç£ç›˜ç©ºé—´ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿä¼šå½±å“ç³»ç»Ÿè¿è¡Œé€Ÿåº¦ã€‚æ­¤æ—¶ï¼Œå°±éœ€è¦ Kubelet å®¹å™¨å›æ”¶äº†ã€‚è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼ŒKubelet å›æ”¶çš„å®¹å™¨æ˜¯æŒ‡é‚£äº›ç”±å…¶ç®¡ç†çš„çš„å®¹å™¨ï¼ˆä¹Ÿå°±æ˜¯ Pod å®¹å™¨ï¼‰ï¼Œç”¨æˆ·æ‰‹åŠ¨è¿è¡Œçš„å®¹å™¨ä¸ä¼šè¢« Kubelet è¿›è¡Œåƒåœ¾å›æ”¶ã€‚\nä¸å®¹å™¨åƒåœ¾å›æ”¶ç›¸å…³çš„æ§åˆ¶å‚æ•°ä¸»è¦æœ‰ 3 ä¸ªï¼š\n  MinAgeï¼šå®¹å™¨å¯ä»¥è¢«æ‰§è¡Œåƒåœ¾å›æ”¶çš„æœ€å°å¹´é¾„\n  MaxPerPodContainerï¼šæ¯ä¸ª pod å†…å…è®¸å­˜åœ¨çš„æ­»äº¡å®¹å™¨çš„æœ€å¤§æ•°é‡\n  MaxContainersï¼šèŠ‚ç‚¹ä¸Šå…¨éƒ¨æ­»äº¡å®¹å™¨çš„æœ€å¤§æ•°é‡\n   æ³¨æ„ï¼šå½“ MaxPerPodContainer ä¸ MaxContainers å‘ç”Ÿå†²çªæ—¶ï¼ŒKubelet ä¼šè‡ªåŠ¨è°ƒæ•´ MaxPerPodContainer çš„å–å€¼ä»¥æ»¡è¶³ MaxContainers è¦æ±‚ã€‚\n ä¸»ä½“æµç¨‹  å®¹å™¨å›æ”¶ä¸»è¦é’ˆå¯¹ä¸‰ä¸ªç›®æ ‡èµ„æºï¼šæ™®é€šå®¹å™¨ã€sandbox å®¹å™¨ä»¥åŠå®¹å™¨æ—¥å¿—ç›®å½•ã€‚\nå¯¹äºæ™®é€šå®¹å™¨ï¼Œä¸»è¦æ ¹æ® MaxPerPodContainer ä¸ MaxContainers çš„è®¾ç½®ï¼ŒæŒ‰ç…§ LRU ç­–ç•¥ï¼Œä» Pod çš„æ­»äº¡å®¹å™¨åˆ—è¡¨åˆ é™¤ä¸€å®šæ•°é‡çš„å®¹å™¨ï¼Œç›´åˆ°æ»¡è¶³é…ç½®éœ€æ±‚ï¼›å¯¹äº sandbox å®¹å™¨ï¼ŒæŒ‰ç…§æ¯ä¸ª Pod ä¿ç•™ä¸€ä¸ªçš„åŸåˆ™æ¸…ç†å¤šä½™çš„æ­»äº¡ sandboxï¼›å¯¹äºæ—¥å¿—ç›®å½•ï¼Œåªè¦æ²¡æœ‰ Pod ä¸ä¹‹å…³è”äº†å°±å°†å…¶åˆ é™¤ã€‚\nKubelet çš„å®¹å™¨åƒåœ¾å›æ”¶åªé’ˆå¯¹ Pod å®¹å™¨ï¼Œé Kubelet Pod å®¹å™¨ï¼ˆæ¯”å¦‚é€šè¿‡ docker run å¯åŠ¨çš„å®¹å™¨ï¼‰ä¸ä¼šè¢«ä¸»åŠ¨æ¸…ç†ã€‚\nç”¨æˆ·é…ç½® å½±å“å®¹å™¨åƒåœ¾å›æ”¶çš„å…³é”®å‚æ•°æœ‰ï¼š\nminimum-container-ttl-durationï¼šå®¹å™¨å¯è¢«å›æ”¶çš„æœ€å°ç”Ÿå­˜å¹´é¾„ï¼Œé»˜è®¤æ˜¯ 0 åˆ†é’Ÿï¼Œè¿™æ„å‘³ç€æ¯ä¸ªæ­»äº¡å®¹å™¨éƒ½ä¼šè¢«ç«‹å³æ‰§è¡Œåƒåœ¾å›æ”¶\nmaximum-dead-containers-per-container`ï¼šæ¯ä¸ª Pod è¦ä¿ç•™çš„æ­»äº¡å®¹å™¨çš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤å€¼ä¸º `1 maximum-dead-containersï¼šèŠ‚ç‚¹å¯ä¿ç•™çš„æ­»äº¡å®¹å™¨çš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤å€¼æ˜¯ -1ï¼Œè¿™æ„å‘³ç€èŠ‚ç‚¹æ²¡æœ‰é™åˆ¶æ­»äº¡å®¹å™¨æ•°é‡\nå®éªŒç¯èŠ‚ è¿˜æ˜¯ä»¥ nginx ä¸ºä¾‹ï¼Œåˆ›å»ºä¸€ä¸ª nginx æœåŠ¡ï¼š\nroot@shida-machine:~# kubectl run nginx --image nginx deployment.apps/nginx created root@shida-machine:~# docker ps -a | grep nginx 7bef0308d9ea nginx \u0026quot;nginx -g 'daemon ofâ€¦\u0026quot; 16 seconds ago Up 14 seconds k8s_nginx_nginx-7db9fccd9b-p2p2t_default_69c38c2b-a64e-11e9-94bd-000c29ce064a_0 7e65e0db52c2 k8s.gcr.io/pause:3.1 \u0026quot;/pause\u0026quot; 2 minutes ago Up 2 minutes k8s_POD_nginx-7db9fccd9b-p2p2t_default_69c38c2b-a64e-11e9-94bd-000c29ce064a_0 å¯ä»¥çœ‹åˆ°ï¼ŒKubelet å¯åŠ¨äº†ä¸€ä¸ª sandbox ä»¥åŠä¸€ä¸ª nginx å®ä¾‹ã€‚\næ‰‹åŠ¨æ€æ­» nginx å®ä¾‹ï¼Œæ¨¡æ‹Ÿå®¹å™¨å¼‚å¸¸é€€å‡ºï¼š\nroot@shida-machine:~# docker kill 7bef0308d9ea 7bef0308d9ea root@shida-machine:~# docker ps -a | grep nginx 408b23b2b72a nginx \u0026quot;nginx -g 'daemon ofâ€¦\u0026quot; 3 seconds ago Up 2 seconds k8s_nginx_nginx-7db9fccd9b-p2p2t_default_69c38c2b-a64e-11e9-94bd-000c29ce064a_1 7bef0308d9ea nginx \u0026quot;nginx -g 'daemon ofâ€¦\u0026quot; 2 minutes ago Exited (137) 15 seconds ago k8s_nginx_nginx-7db9fccd9b-p2p2t_default_69c38c2b-a64e-11e9-94bd-000c29ce064a_0 7e65e0db52c2 k8s.gcr.io/pause:3.1 \u0026quot;/pause\u0026quot; 5 minutes ago Up 5 minutes k8s_POD_nginx-7db9fccd9b-p2p2t_default_69c38c2b-a64e-11e9-94bd-000c29ce064a_0 å¯ä»¥çœ‹åˆ° Kubelet é‡æ–°æ‹‰èµ·äº†ä¸€ä¸ªæ–°çš„ nginx å®ä¾‹ã€‚\nç­‰å¾…å‡ åˆ†é’Ÿï¼Œå‘ç° Kubelet å¹¶æœªæ¸…ç†å¼‚å¸¸é€€å‡ºçš„ nginx å®¹å™¨ï¼ˆå› ä¸ºæ­¤æ—¶ä»…æœ‰ä¸€ä¸ª dead containerï¼‰ã€‚\nroot@shida-machine:~# docker ps -a | grep nginx 408b23b2b72a nginx \u0026quot;nginx -g 'daemon ofâ€¦\u0026quot; 3 minutes ago Up 3 minutes k8s_nginx_nginx-7db9fccd9b-p2p2t_default_69c38c2b-a64e-11e9-94bd-000c29ce064a_1 7bef0308d9ea nginx \u0026quot;nginx -g 'daemon ofâ€¦\u0026quot; 5 minutes ago Exited (137) 3 minutes ago k8s_nginx_nginx-7db9fccd9b-p2p2t_default_69c38c2b-a64e-11e9-94bd-000c29ce064a_0 7e65e0db52c2 k8s.gcr.io/pause:3.1 \u0026quot;/pause\u0026quot; 8 minutes ago Up 8 minutes k8s_POD_nginx-7db9fccd9b-p2p2t_default_69c38c2b-a64e-11e9-94bd-000c29ce064a_0 ç»§ç»­æ€æ­»å½“å‰ nginx å®ä¾‹ï¼š\nroot@shida-machine:~# docker kill 408b23b2b72a 408b23b2b72a root@shida-machine:~# docker ps -a | grep nginx e064e376819f nginx \u0026quot;nginx -g 'daemon ofâ€¦\u0026quot; 9 seconds ago Up 7 seconds k8s_nginx_nginx-7db9fccd9b-p2p2t_default_69c38c2b-a64e-11e9-94bd-000c29ce064a_2 408b23b2b72a nginx \u0026quot;nginx -g 'daemon ofâ€¦\u0026quot; 5 minutes ago Exited (137) 40 seconds ago k8s_nginx_nginx-7db9fccd9b-p2p2t_default_69c38c2b-a64e-11e9-94bd-000c29ce064a_1 7e65e0db52c2 k8s.gcr.io/pause:3.1 \u0026quot;/pause\u0026quot; 10 minutes ago Up 10 minutes k8s_POD_nginx-7db9fccd9b-p2p2t_default_69c38c2b-a64e-11e9-94bd-000c29ce064a_0 è¿™ä¸‹çœ‹åˆ°æ•ˆæœäº†ï¼Œä»ç„¶åªæœ‰ä¸€ä¸ªé€€å‡ºçš„å®¹å™¨è¢«ä¿ç•™ï¼Œè€Œä¸”è¢«æ¸…ç†æ‰çš„æ˜¯æœ€è€çš„æ­»äº¡å®¹å™¨ï¼Œè¿™ä¸ä¹‹å‰çš„åˆ†ææ˜¯ä¸€è‡´çš„ï¼\nåˆ é™¤è¿™ä¸ª nginx Deploymentï¼Œä¼šå‘ç°æ‰€æœ‰çš„ nginx å®¹å™¨éƒ½ä¼šè¢«æ¸…ç†ï¼š\nroot@shida-machine:~# kubectl delete deployment nginx deployment.extensions \u0026quot;nginx\u0026quot; deleted root@shida-machine:~# docker ps -a | grep nginx root@shida-machine:~# è¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬ä¿®æ”¹ Kubelet å‚æ•°ï¼Œè®¾ç½® maximum-dead-containers ä¸º 0ï¼Œè¿™å°±å‘Šè¯‰ Kubelet æ¸…ç†æ‰€æœ‰æ­»äº¡å®¹å™¨ã€‚\né‡å¤å‰è¾¹çš„å®éªŒæ­¥éª¤ï¼š\nroot@shida-machine:~# kubectl run nginx --image nginx deployment.apps/nginx created root@shida-machine:~# docker ps -a | grep nginx 8de9ae8e2c9b nginx \u0026quot;nginx -g 'daemon ofâ€¦\u0026quot; 33 seconds ago Up 32 seconds k8s_nginx_nginx-7db9fccd9b-jl2xn_default_0cd67a29-a6a2-11e9-94bd-000c29ce064a_0 d2cdfafdbe50 k8s.gcr.io/pause:3.1 \u0026quot;/pause\u0026quot; 41 seconds ago Up 38 seconds k8s_POD_nginx-7db9fccd9b-jl2xn_default_0cd67a29-a6a2-11e9-94bd-000c29ce064a_0 root@shida-machine:~# docker kill 8de9ae8e2c9b 8de9ae8e2c9b root@shida-machine:~# docker ps -a | grep nginx 95ee5bd2cab2 nginx \u0026quot;nginx -g 'daemon ofâ€¦\u0026quot; About a minute ago Up About a minute k8s_nginx_nginx-7db9fccd9b-jl2xn_default_0cd67a29-a6a2-11e9-94bd-000c29ce064a_1 d2cdfafdbe50 k8s.gcr.io/pause:3.1 \u0026quot;/pause\u0026quot; 2 minutes ago Up About a minute k8s_POD_nginx-7db9fccd9b-jl2xn_default_0cd67a29-a6a2-11e9-94bd-000c29ce064a_0 ç»“æœæ˜¾ç¤ºï¼Œnginx Pod çš„æ‰€æœ‰æ­»äº¡å®¹å™¨éƒ½ä¼šè¢«æ¸…ç†ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»å¼ºåˆ¶è¦æ±‚èŠ‚ç‚¹ä¸ä¿ç•™ä»»ä½•æ­»äº¡å®¹å™¨ï¼Œä¸é¢„æœŸä¸€è‡´ï¼\né‚£å¯¹äºæ‰‹åŠ¨è¿è¡Œçš„å®¹å™¨å‘¢ï¼Ÿæˆ‘ä»¬é€šè¿‡ docker run è¿è¡Œ nginxï¼š\nroot@shida-machine:~# docker run --name nginx -d nginx 46ebb365f6be060a6950f44728e4f11e4666bf2fb007cad557ffc65ecf8aded8 root@shida-machine:~# docker ps | grep nginx 46ebb365f6be nginx \u0026quot;nginx -g 'daemon ofâ€¦\u0026quot; 9 seconds ago Up 6 seconds 80/tcp nginx æ€æ­»è¯¥å®¹å™¨ï¼š\nroot@shida-machine:~# docker kill 46ebb365f6be 46ebb365f6be root@shida-machine:~# docker ps -a | grep nginx 46ebb365f6be nginx \u0026quot;nginx -g 'daemon ofâ€¦\u0026quot; About a minute ago Exited (137) 18 seconds ago nginx ç»è¿‡å‡ åˆ†é’Ÿï¼Œæˆ‘ä»¬å‘ç°è¯¥æ­»äº¡å®¹å™¨è¿˜æ˜¯ä¼šå­˜åœ¨çš„ï¼ŒKubelet ä¸ä¼šæ¸…ç†è¿™ç±»å®¹å™¨ï¼\nå°ç»“ Kubelet æ¯ 5 åˆ†é’Ÿè¿›è¡Œä¸€æ¬¡é•œåƒæ¸…ç†ã€‚å½“ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡ä¸Šé™é˜ˆå€¼ï¼ŒKubelet ä¼šæŒ‰ç…§ LRU ç­–ç•¥é€ä¸€æ¸…ç†æ²¡æœ‰è¢«ä»»ä½•å®¹å™¨æ‰€ä½¿ç”¨çš„é•œåƒï¼Œç›´åˆ°ç£ç›˜ä½¿ç”¨ç‡é™åˆ°ä¸‹é™é˜ˆå€¼æˆ–æ²¡æœ‰ç©ºé—²é•œåƒå¯ä»¥æ¸…ç†ã€‚Kubelet è®¤ä¸ºé•œåƒå¯è¢«æ¸…ç†çš„æ ‡å‡†æ˜¯æœªè¢«ä»»ä½• Pod å®¹å™¨ï¼ˆåŒ…æ‹¬é‚£äº›æ­»äº¡äº†çš„å®¹å™¨ï¼‰æ‰€å¼•ç”¨ï¼Œé‚£äº›é Pod å®¹å™¨ï¼ˆå¦‚ç”¨æˆ·é€šè¿‡ docker run å¯åŠ¨çš„å®¹å™¨ï¼‰æ˜¯ä¸ä¼šè¢«ç”¨æ¥è®¡ç®—é•œåƒå¼•ç”¨å…³ç³»çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä¾¿ç”¨æˆ·è¿è¡Œçš„å®¹å™¨ä½¿ç”¨äº† A é•œåƒï¼Œåªè¦æ²¡æœ‰ä»»ä½• Pod å®¹å™¨ä½¿ç”¨åˆ° Aï¼Œé‚£ A é•œåƒå¯¹äº Kubelet è€Œè¨€å°±æ˜¯å¯è¢«å›æ”¶çš„ã€‚ä½†æ˜¯æˆ‘ä»¬æ— éœ€æ‹…å¿ƒæ‰‹åŠ¨è¿è¡Œå®¹å™¨ä½¿ç”¨çš„é•œåƒä¼šè¢«æ„å¤–å›æ”¶ï¼Œå› ä¸º Kubelet çš„é•œåƒåˆ é™¤æ˜¯é force ç±»å‹çš„ï¼Œåº•å±‚å®¹å™¨è¿è¡Œæ—¶ä¼šä½¿å­˜åœ¨å®¹å™¨å…³è”çš„é•œåƒåˆ é™¤æ“ä½œå¤±è´¥ï¼ˆå› ä¸º Docker ä¼šè®¤ä¸ºä»æœ‰å®¹å™¨ä½¿ç”¨ç€ A é•œåƒï¼‰ã€‚\nKubelet æ¯ 1 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡å®¹å™¨æ¸…ç†ã€‚æ ¹æ®å¯åŠ¨é…ç½®å‚æ•°ï¼ŒKubelet ä¼šæŒ‰ç…§ LRU ç­–ç•¥ä¾æ¬¡æ¸…ç†æ¯ä¸ª Pod å†…çš„æ­»äº¡å®¹å™¨ï¼Œç›´åˆ°è¾¾åˆ°æ­»äº¡å®¹å™¨é™åˆ¶æ•°è¦æ±‚ï¼Œå¯¹äº sandbox å®¹å™¨ï¼ŒKubelet ä»…ä¼šä¿ç•™æœ€æ–°çš„ï¼ˆè¿™ä¸å— GC ç­–ç•¥çš„æ§åˆ¶ï¼‰ã€‚å¯¹äºæ—¥å¿—ç›®å½•ï¼Œåªè¦å·²ç»æ²¡æœ‰ Pod ç»§ç»­å ç”¨ï¼Œå°±å°†å…¶æ¸…ç†ã€‚å¯¹äºé Pod å®¹å™¨ï¼ˆå¦‚ç”¨æˆ·é€šè¿‡ docker run å¯åŠ¨çš„å®¹å™¨ï¼‰ä¸ä¼šè¢« Kubelet åƒåœ¾å›æ”¶ã€‚\n","permalink":"https://srcio.cn/posts/kubelet-recycle-policy/","summary":"æ–‡ç« è½¬è½½è‡ªï¼šhttps://sataqiu.github.io/2019/07/15/k8s-kubelet-gc/index.html Kubelet åƒ","title":"Kubelet åƒåœ¾å›æ”¶åŸç†å‰–æ"},{"content":"CRD å­—æ®µæ ¡éªŒé…ç½®\napiVersion:apiextensions.k8s.io/v1beta1kind:CustomResourceDefinitionmetadata:name:scalings.control.srcio.iospec:group:control.srcio.ioversions:- name:v1served:truestorage:truescope:Namespacednames:plural:scalingssingular:scalingkind:Scalingvalidation:openAPIV3Schema:properties:spec:required:- targetDeployment- minReplicas- maxReplicas- metricType- step- scaleUp- scaleDownproperties:targetDeployment:type:stringminReplicas:type:integerminimum:0maxReplicas:type:integerminimum:0metricType:type:stringenum:- CPU- MEMORY- REQUESTSstep:type:integerminimum:1scaleUp:type:integerscaleDown:type:integerminimum:0  æ˜¯å¦å¿…é¡» å‚æ•°ç±»å‹ æšä¸¾èŒƒå›´ æ•°å€¼æœ€å¤§æœ€å°   ","permalink":"https://srcio.cn/series/programming-kubernetes/crd/","summary":"CRD å­—æ®µæ ¡éªŒé…ç½® apiVersion:apiextensions.k8s.io/v1beta1kind:CustomResourceDefinitionmetadata:name:scalings.control.srcio.iospec:group:control.srcio.ioversions:- name:v1served:truestorage:truescope:Namespacednames:plural:scalingssingular:scalingkind:Scalingvalidation:openAPIV3Schema:properties:spec:required:- targetDeployment- minReplicas- maxReplicas- metricType- step- scaleUp- scaleDownproperties:targetDeployment:type:stringminReplicas:type:integerminimum:0maxReplicas:type:integerminimum:0metricType:type:stringenum:- CPU- MEMORY- REQUESTSstep:type:integerminimum:1scaleUp:type:integerscaleDown:type:integerminimum:0 æ˜¯å¦å¿…é¡» å‚æ•°ç±»å‹ æšä¸¾èŒƒå›´ æ•°å€¼æœ€å¤§æœ€å°","title":"CRD ç®€ä»‹"},{"content":"æ€ä¹ˆç†è§£åˆ‡ç‰‡ s = append(s, item) éœ€è¦ä½¿ç”¨ s é‡æ–°æ¥æ”¶å‘¢ï¼Ÿ\n åœ¨ golang è¯­è¨€ä¸­æ‰€æœ‰çš„å‚æ•°ä¼ é€’çš„æ–¹å¼éƒ½æ˜¯å€¼ä¼ é€’çš„ï¼Œå³ä¾¿æ˜¯æŒ‡é’ˆï¼Œä¹Ÿæ˜¯å¤åˆ¶äº†ä¸€ä»½æŒ‡é’ˆä¼ é€’ï¼› åˆ‡ç‰‡å‘ç”Ÿæ‰©å®¹åï¼Œåº•å±‚çš„æ•°ç»„å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸å†æ˜¯åŸæ¥çš„æ•°ç»„ç»“æ„ã€‚   ","permalink":"https://srcio.cn/series/programming-go/slice-append/","summary":"æ€ä¹ˆç†è§£åˆ‡ç‰‡ s = append(s, item) éœ€è¦ä½¿ç”¨ s é‡æ–°æ¥æ”¶å‘¢ï¼Ÿ åœ¨ golang è¯­è¨€ä¸­æ‰€æœ‰çš„å‚æ•°ä¼ é€’çš„æ–¹å¼éƒ½æ˜¯å€¼ä¼ é€’çš„ï¼Œå³ä¾¿æ˜¯æŒ‡é’ˆï¼Œä¹Ÿæ˜¯å¤åˆ¶äº†ä¸€ä»½æŒ‡é’ˆä¼ é€’ï¼› åˆ‡ç‰‡å‘ç”Ÿæ‰©å®¹åï¼Œåº•","title":"Golang åˆ‡ç‰‡æ‰©å®¹"},{"content":"å®‰è£… å¦‚æœä½ å®‰è£…äº† Docker Desktopï¼Œé‚£ä¹ˆå®ƒå·²ç»å¸®ä½ è‡ªåŠ¨å®‰è£…äº† Docker Compose æ’ä»¶ã€‚å¦åˆ™ï¼Œéœ€è¦é¢å¤–å®‰è£…æ’ä»¶ã€‚\nä½¿ç”¨ä¸€ä¸‹å‘½ä»¤å®‰è£…æˆ–å‡çº§ Docker Composeï¼ˆlinuxï¼‰ï¼š\n Ubuntuï¼ŒDebianï¼š  sudo apt update sudo apt install docker-compose-plugin  åŸºäº RPM å‘è¡Œç‰ˆ:  sudo yum update sudo yum install docker-compose-plugin éªŒè¯å®‰è£…ç‰ˆæœ¬ï¼š\ndocker-compose version å¸¸ç”¨å‘½ä»¤ è¿è¡Œ\ndocker-compose up æŸ¥çœ‹è¿è¡Œ\ndocker-compose ps åœæ­¢\ndocker-compose stop å¯åŠ¨\u0026amp;é‡å¯\ndocker-compose start docker-compose restart é€€å‡º\ndocker-compose down ä½¿ç”¨ docker-compose -h æŸ¥çœ‹æ›´å¤šå‘½ä»¤åŠå‚æ•°ã€‚\nå®è·µ ä½¿ç”¨ Docker Compose è¿è¡Œä¸€ä¸ªç®€å•çš„ golang web ç¨‹åºã€‚\n ç¨‹åºåˆå§‹åŒ–  mkdir docker-compose-go-demo cd docker-compose-go-demo go mod init docker-compose-go-demo åˆ›å»º main.go æ–‡ä»¶ï¼Œå¹¶å†™å…¥ç¨‹åºä»£ç   package main import ( \u0026#34;fmt\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;time\u0026#34; ) func greet(w http.ResponseWriter, r *http.Request) { fmt.Fprintf(w, \u0026#34;Hello Docker Compose! %s\u0026#34;, time.Now()) } func main() { http.HandleFunc(\u0026#34;/\u0026#34;, greet) http.ListenAndServe(\u0026#34;:8080\u0026#34;, nil) } åˆ›å»º Dockerfile æ–‡ä»¶ï¼Œå¹¶ç¼–å†™å†…å®¹  FROMgolang:alpineWORKDIR/appCOPY . .EXPOSE8080ENTRYPOINT [ \u0026#34;go\u0026#34;,\u0026#34;run\u0026#34;,\u0026#34;main.go\u0026#34; ]åˆ›å»º docker-comppose.yml æ–‡ä»¶ï¼Œå¹¶ç¼–å†™å†…å®¹  version:\u0026#34;3.9\u0026#34;services:web:build:.# image: docker-compose-go-demo_web:v1# image: docker-compose-go-demo_web:v2ports:- \u0026#34;8080:8080\u0026#34;å¯åŠ¨æœåŠ¡  docker-compose up -d åœºæ™¯ï¼š\n web æœåŠ¡ä¸šåŠ¡ä»£ç ä¿®æ”¹äº†ï¼Œå¸Œæœ›ä¸åœæœºæ›´æ–°æœåŠ¡ï¼š  docker-compose up -d --build  åŒ…å«å¤šä¸ªæœåŠ¡ï¼Œä¾‹å¦‚ä¸­é—´ä»¶ï¼Œä½†åªæƒ³é‡æ–°ç¼–è¯‘å…¶ä¸­ä¸šåŠ¡æœåŠ¡ï¼Œå¦‚ webï¼š  docker-compose up -d --no-deps --build web  å¦‚æœ docker-compose.yml ç›´æ¥ä½¿ç”¨çš„é•œåƒï¼Œé‚£ä¹ˆç›´æ¥æ›´æ–°ï¼Œå†æ¬¡ docker-compose up -d å³å¯ã€‚\n ","permalink":"https://srcio.cn/posts/docker-compose/","summary":"å®‰è£… å¦‚æœä½ å®‰è£…äº† Docker Desktopï¼Œé‚£ä¹ˆå®ƒå·²ç»å¸®ä½ è‡ªåŠ¨å®‰è£…äº† Docker Compose æ’ä»¶ã€‚å¦åˆ™ï¼Œéœ€è¦é¢å¤–å®‰è£…æ’ä»¶ã€‚ ä½¿ç”¨ä¸€ä¸‹å‘½ä»¤å®‰è£…æˆ–å‡çº§ Docker Composeï¼ˆlinu","title":"Docker Compose å®è·µ"},{"content":"ä»£ç å®ç° package certutil import ( \u0026#34;bytes\u0026#34; \u0026#34;crypto/rand\u0026#34; \u0026#34;crypto/rsa\u0026#34; \u0026#34;crypto/x509\u0026#34; \u0026#34;crypto/x509/pkix\u0026#34; \u0026#34;encoding/pem\u0026#34; \u0026#34;math/big\u0026#34; \u0026#34;net\u0026#34; \u0026#34;time\u0026#34; ) // CA ca type CA struct { caInfo *x509.Certificate caPrivKey *rsa.PrivateKey caPem, caKeyPem []byte } // GetCAPem get ca pem bytes func (c *CA) GetCAPem() ([]byte, error) { if c.caPem == nil { // create the CA \tcaBytes, err := x509.CreateCertificate(rand.Reader, c.caInfo, c.caInfo, \u0026amp;c.caPrivKey.PublicKey, c.caPrivKey) if err != nil { return nil, err } // pem encode \tcaPEM := new(bytes.Buffer) _ = pem.Encode(caPEM, \u0026amp;pem.Block{ Type: \u0026#34;CERTIFICATE\u0026#34;, Bytes: caBytes, }) c.caPem = caPEM.Bytes() } return c.caPem, nil } // GetCAKeyPem get ca key pem func (c *CA) GetCAKeyPem() ([]byte, error) { if c.caKeyPem == nil { caPrivKeyPEM := new(bytes.Buffer) _ = pem.Encode(caPrivKeyPEM, \u0026amp;pem.Block{ Type: \u0026#34;RSA PRIVATE KEY\u0026#34;, Bytes: x509.MarshalPKCS1PrivateKey(c.caPrivKey), }) c.caKeyPem = caPrivKeyPEM.Bytes() } return c.caKeyPem, nil } // CreateCert make Certificate func (c *CA) CreateCert(ips []string, domains ...string) (certPem, certKey []byte, err error) { var ipAddresses []net.IP for _, ip := range ips { if i := net.ParseIP(ip); i != nil { ipAddresses = append(ipAddresses, i) } } // set up our server certificate \tcert := \u0026amp;x509.Certificate{ SerialNumber: big.NewInt(2019), Subject: pkix.Name{ Organization: []string{\u0026#34;srcio.cn\u0026#34;}, Country: []string{\u0026#34;CN\u0026#34;}, Province: []string{\u0026#34;Beijing\u0026#34;}, Locality: []string{\u0026#34;Beijing\u0026#34;}, StreetAddress: []string{\u0026#34;Beijing\u0026#34;}, PostalCode: []string{\u0026#34;000000\u0026#34;}, }, DNSNames: domains, IPAddresses: ipAddresses, NotBefore: time.Now(), NotAfter: time.Now().AddDate(99, 0, 0), SubjectKeyId: []byte{1, 2, 3, 4, 6}, ExtKeyUsage: []x509.ExtKeyUsage{x509.ExtKeyUsageClientAuth, x509.ExtKeyUsageServerAuth}, KeyUsage: x509.KeyUsageDigitalSignature, } certPrivKey, err := rsa.GenerateKey(rand.Reader, 4096) if err != nil { return nil, nil, err } certBytes, err := x509.CreateCertificate(rand.Reader, cert, c.caInfo, \u0026amp;certPrivKey.PublicKey, c.caPrivKey) if err != nil { return nil, nil, err } certPEM := new(bytes.Buffer) _ = pem.Encode(certPEM, \u0026amp;pem.Block{ Type: \u0026#34;CERTIFICATE\u0026#34;, Bytes: certBytes, }) certPrivKeyPEM := new(bytes.Buffer) _ = pem.Encode(certPrivKeyPEM, \u0026amp;pem.Block{ Type: \u0026#34;RSA PRIVATE KEY\u0026#34;, Bytes: x509.MarshalPKCS1PrivateKey(certPrivKey), }) return certPEM.Bytes(), certPrivKeyPEM.Bytes(), nil } // CreateCA create ca info func CreateCA() (*CA, error) { // set up our CA certificate \tca := \u0026amp;x509.Certificate{ SerialNumber: big.NewInt(2019), Subject: pkix.Name{ Organization: []string{\u0026#34;srcio.cn\u0026#34;}, Country: []string{\u0026#34;CN\u0026#34;}, Province: []string{\u0026#34;Beijing\u0026#34;}, Locality: []string{\u0026#34;Beijing\u0026#34;}, StreetAddress: []string{\u0026#34;Beijing\u0026#34;}, PostalCode: []string{\u0026#34;000000\u0026#34;}, }, NotBefore: time.Now(), NotAfter: time.Now().AddDate(99, 0, 0), IsCA: true, ExtKeyUsage: []x509.ExtKeyUsage{x509.ExtKeyUsageClientAuth, x509.ExtKeyUsageServerAuth}, KeyUsage: x509.KeyUsageDigitalSignature | x509.KeyUsageCertSign, BasicConstraintsValid: true, } // create our private and public key \tcaPrivKey, err := rsa.GenerateKey(rand.Reader, 4096) if err != nil { return nil, err } return \u0026amp;CA{ caInfo: ca, caPrivKey: caPrivKey, }, nil } // ParseCA parse caPem func ParseCA(caPem, caKeyPem []byte) (*CA, error) { p := \u0026amp;pem.Block{} p, caPem = pem.Decode(caPem) ca, err := x509.ParseCertificate(p.Bytes) if err != nil { return nil, err } p2 := \u0026amp;pem.Block{} p2, caKeyPem = pem.Decode(caKeyPem) caKey, err := x509.ParsePKCS1PrivateKey(p2.Bytes) if err != nil { return nil, err } return \u0026amp;CA{ caInfo: ca, caPrivKey: caKey, caPem: caPem, caKeyPem: caKeyPem, }, nil } // DomainSign create cert func DomainSign(ips []string, domains ...string) ([]byte, []byte, []byte, error) { ca, err := CreateCA() if err != nil { return nil, nil, nil, err } caPem, err := ca.GetCAPem() if err != nil { return nil, nil, nil, err } certPem, certKey, err := ca.CreateCert(ips, domains...) if err != nil { return nil, nil, nil, err } return caPem, certPem, certKey, nil } ","permalink":"https://srcio.cn/series/programming-go/gen-cert/","summary":"ä»£ç å®ç° package certutil import ( \u0026#34;bytes\u0026#34; \u0026#34;crypto/rand\u0026#34; \u0026#34;crypto/rsa\u0026#34; \u0026#34;crypto/x509\u0026#34; \u0026#34;crypto/x509/pkix\u0026#34; \u0026#34;encoding/pem\u0026#34; \u0026#34;math/big\u0026#34; \u0026#34;net\u0026#34; \u0026#34;time\u0026#34; ) // CA ca type CA struct { caInfo *x509.Certificate caPrivKey *rsa.PrivateKey caPem, caKeyPem []byte } // GetCAPem get ca pem bytes func (c *CA) GetCAPem() ([]byte, error) { if c.caPem == nil { // create the CA caBytes, err := x509.CreateCertificate(rand.Reader, c.caInfo, c.caInfo, \u0026amp;c.caPrivKey.PublicKey, c.caPrivKey) if err != nil { return nil,","title":"Golang ç”Ÿæˆè¯ä¹¦"},{"content":"TLS ä¼ è¾“å±‚å®‰å…¨åè®®ï¼ˆTLSï¼‰ï¼Œåœ¨äº’è”ç½‘ä¸Šï¼Œé€šå¸¸æ˜¯ç”±æœåŠ¡å™¨å•å‘çš„å‘å®¢æˆ·ç«¯æä¾›è¯ä¹¦ï¼Œä»¥è¯æ˜å…¶èº«ä»½ã€‚\nmTLS åŒå‘ TLS è®¤è¯ï¼Œæ˜¯æŒ‡åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ä½¿ç”¨åŒè¡ŒåŠ å¯†é€šé“ï¼ŒmTLS æ˜¯äº‘åŸç”Ÿåº”ç”¨ä¸­å¸¸ç”¨çš„é€šä¿¡å®‰å…¨åè®®ã€‚\nä½¿ç”¨åŒå‘TLSè¿æ¥çš„ä¸»è¦ç›®çš„æ˜¯å½“æœåŠ¡å™¨åº”è¯¥åªæ¥å—æ¥è‡ªæœ‰é™çš„å…è®¸çš„å®¢æˆ·ç«¯çš„ TLS è¿æ¥æ—¶ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç»„ç»‡å¸Œæœ›å°†æœåŠ¡å™¨çš„ TLS è¿æ¥é™åˆ¶ä¸ºåªæ¥è‡ªè¯¥ç»„ç»‡çš„åˆæ³•åˆä½œä¼™ä¼´æˆ–å®¢æˆ·ã€‚æ˜¾ç„¶ï¼Œä¸ºå®¢æˆ·ç«¯æ·»åŠ IPç™½åå•ä¸æ˜¯ä¸€ä¸ªå¥½çš„å®‰å…¨å®è·µï¼Œå› ä¸ºIPå¯èƒ½è¢«æ¬ºéª—ã€‚\nä¸ºäº†ç®€åŒ– mTLS æ¡æ‰‹çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬è¿™æ ·ç®€å•æ¢³ç†ï¼š\n  å®¢æˆ·ç«¯å‘é€è®¿é—®æœåŠ¡å™¨ä¸Šå—ä¿æŠ¤ä¿¡æ¯çš„è¯·æ±‚ï¼›\n  æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æä¾›å…¬é’¥è¯ä¹¦ï¼›\n  å®¢æˆ·ç«¯é€šè¿‡ä½¿ç”¨ CA çš„å…¬é’¥æ¥éªŒè¯æœåŠ¡å™¨å…¬é’¥è¯ä¹¦çš„æ•°å­—ç­¾åï¼Œä»¥éªŒè¯æœåŠ¡å™¨çš„è¯ä¹¦ï¼›\n  å¦‚æœæ­¥éª¤ 3 æˆåŠŸï¼Œå®¢æˆ·æœºå°†å…¶å®¢æˆ·ç«¯å…¬é’¥è¯ä¹¦å‘é€åˆ°æœåŠ¡å™¨ï¼›\n  æœåŠ¡å™¨ä½¿ç”¨æ­¥éª¤ 3 ä¸­ç›¸åŒçš„æ–¹æ³•éªŒè¯å®¢æˆ·æœºçš„è¯ä¹¦ï¼›\n  å¦‚æœæˆåŠŸï¼ŒæœåŠ¡å™¨å°†å¯¹å—ä¿æŠ¤ä¿¡æ¯çš„è®¿é—®æƒæˆäºˆå®¢æˆ·æœºã€‚\n  ä»£ç å®ç° éœ€è¦å®ç°å®¢æˆ·ç«¯éªŒè¯æœåŠ¡ç«¯çš„å…¬é’¥è¯ä¹¦ï¼ŒæœåŠ¡ç«¯éªŒè¯å®¢æˆ·ç«¯çš„å…¬é’¥è¯ä¹¦ã€‚\nç”Ÿæˆè¯ä¹¦ echo \u0026#39;æ¸…ç†å¹¶ç”Ÿæˆç›®å½•\u0026#39; OUT=./certs DAYS=365 RSALEN=2048 CN=srcio rm -rf ${OUT}/* mkdir ${OUT} \u0026gt;\u0026gt; /dev/null 2\u0026gt;\u0026amp;1 cd ${OUT} echo \u0026#39;ç”ŸæˆCAçš„ç§é’¥\u0026#39; openssl genrsa -out ca.key ${RSALEN} \u0026gt;\u0026gt; /dev/null 2\u0026gt;\u0026amp;1 echo \u0026#39;ç”ŸæˆCAçš„ç­¾åè¯ä¹¦\u0026#39; openssl req -new \\ -x509 \\ -key ca.key \\ -subj \u0026#34;/CN=${CN}\u0026#34; \\ -out ca.crt echo \u0026#39;\u0026#39; echo \u0026#39;ç”Ÿæˆserverç«¯ç§é’¥\u0026#39; openssl genrsa -out server.key ${RSALEN} \u0026gt;\u0026gt; /dev/null 2\u0026gt;\u0026amp;1 echo \u0026#39;ç”Ÿæˆserverç«¯è‡ªç­¾å\u0026#39; openssl req -new \\ -key server.key \\ -subj \u0026#34;/CN=${CN}\u0026#34; \\ -out server.csr echo \u0026#39;ç­¾å‘serverç«¯è¯ä¹¦\u0026#39; openssl x509 -req -sha256 \\ -in server.csr \\ -CA ca.crt -CAkey ca.key -CAcreateserial \\ -out server.crt -text \u0026gt;\u0026gt; /dev/null 2\u0026gt;\u0026amp;1 echo \u0026#39;åˆ é™¤serverç«¯è‡ªç­¾åè¯ä¹¦\u0026#39; rm server.csr echo \u0026#39;\u0026#39; echo \u0026#39;ç”Ÿæˆclientç§é’¥\u0026#39; openssl genrsa -out client.key ${RSALEN} \u0026gt;\u0026gt; /dev/null 2\u0026gt;\u0026amp;1 echo \u0026#39;ç”Ÿæˆclientè‡ªç­¾å\u0026#39; openssl req -new \\  -subj \u0026#34;/CN=${CN}\u0026#34; \\  -key client.key \\  -out client.csr echo \u0026#39;ç­¾å‘clientè¯ä¹¦\u0026#39; openssl x509 -req -sha256\\  -CA ca.crt -CAkey ca.key -CAcreateserial\\  -days ${DAYS}\\  -in client.csr\\  -out client.crt\\  -text \u0026gt;\u0026gt; /dev/null 2\u0026gt;\u0026amp;1 echo \u0026#39;åˆ é™¤clientç«¯è‡ªç­¾å\u0026#39; rm client.csr echo \u0026#39;\u0026#39; echo \u0026#39;åˆ é™¤ä¸´æ—¶æ–‡ä»¶\u0026#39; rm ca.srl echo \u0026#39;\u0026#39; echo \u0026#39;å®Œæˆ\u0026#39;% æœåŠ¡ç«¯ package main import ( \u0026#34;crypto/tls\u0026#34; \u0026#34;crypto/x509\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;os\u0026#34; \u0026#34;time\u0026#34; ) var ( caCert = \u0026#34;../../certs/ca.crt\u0026#34; serverCert = \u0026#34;../../certs/server.crt\u0026#34; serverKey = \u0026#34;../../certs/server.key\u0026#34; ) type mtlsHandler struct { } func (m *mtlsHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) { fmt.Fprintln(w, \u0026#34;Hello World! \u0026#34;, time.Now()) } func main() { pool := x509.NewCertPool() caCertBytes, err := os.ReadFile(caCert) if err != nil { panic(err) } pool.AppendCertsFromPEM(caCertBytes) server := \u0026amp;http.Server{ Addr: \u0026#34;:8443\u0026#34;, Handler: \u0026amp;mtlsHandler{}, TLSConfig: \u0026amp;tls.Config{ ClientCAs: pool, ClientAuth: tls.RequireAndVerifyClientCert, // éœ€è¦å®¢æˆ·ç«¯è¯ä¹¦ \t}, } log.Println(\u0026#34;server started...\u0026#34;) log.Fatalln(server.ListenAndServeTLS(serverCert, serverKey)) } å®¢æˆ·ç«¯ package main import ( \u0026#34;crypto/tls\u0026#34; \u0026#34;crypto/x509\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;io\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;os\u0026#34; ) var ( caCert = \u0026#34;../../certs/ca.crt\u0026#34; clientCert = \u0026#34;../../certs/client.crt\u0026#34; clientKey = \u0026#34;../../certs/client.key\u0026#34; ) func main() { pool := x509.NewCertPool() caCertBytes, err := os.ReadFile(caCert) if err != nil { panic(err) } pool.AppendCertsFromPEM(caCertBytes) clientCertBytes, err := tls.LoadX509KeyPair(clientCert, clientKey) if err != nil { panic(err) } tr := \u0026amp;http.Transport{ TLSClientConfig: \u0026amp;tls.Config{ RootCAs: pool, Certificates: []tls.Certificate{clientCertBytes}, InsecureSkipVerify: true, }, } client := http.Client{ Transport: tr, } r, err := client.Get(\u0026#34;https://127.0.0.1:8443\u0026#34;) // server \tif err != nil { panic(err) } defer r.Body.Close() b, err := io.ReadAll(r.Body) if err != nil { panic(err) } fmt.Println(string(b)) } ","permalink":"https://srcio.cn/series/programming-go/mtls/","summary":"TLS ä¼ è¾“å±‚å®‰å…¨åè®®ï¼ˆTLSï¼‰ï¼Œåœ¨äº’è”ç½‘ä¸Šï¼Œé€šå¸¸æ˜¯ç”±æœåŠ¡å™¨å•å‘çš„å‘å®¢æˆ·ç«¯æä¾›è¯ä¹¦ï¼Œä»¥è¯æ˜å…¶èº«ä»½ã€‚ mTLS åŒå‘ TLS è®¤è¯ï¼Œæ˜¯æŒ‡åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ä½¿ç”¨åŒè¡ŒåŠ ","title":"Golang å®ç°åŒå‘è®¤è¯"},{"content":"æœ¬èŠ‚ä»‹ç»å‡ ç§æ„é€  rest.Config å®ä¾‹çš„åœºæ™¯æˆ–è€…æ–¹æ³•ã€‚\nrest.Config å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ„å»ºå„ç§ç±»å‹çš„ Kubernetes å®¢æˆ·ç«¯å®ä¾‹ï¼Œä»è€Œè®¿é—® Kubernetes APIServerã€‚\né€šè¿‡ kubeconfig æ–‡ä»¶æ„é€  ç¨‹åºé€šè¿‡è¯»å– kubeconfig æ–‡ä»¶æ¥æ„é€ ä¸€ä¸ª rest.Config å¯¹è±¡ã€‚\npackage main import ( \u0026#34;k8s.io/client-go/rest\u0026#34; \u0026#34;k8s.io/client-go/tools/clientcmd\u0026#34; ) func KubeConfig() *rest.Config { config, err := clientcmd.BuildConfigFromFlags(\u0026#34;\u0026#34;, clientcmd.RecommendedHomeFile) if err != nil { panic(err) } return config } é€šè¿‡ Secret èµ„æºæ„é€  é€šè¿‡å°†ç¨‹åºéƒ¨ç½²åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œä½¿ç”¨ Pod æ‰€é…ç½®çš„ ServiceAccountï¼ˆé»˜è®¤ï¼šdefaultï¼‰è´¦å·æ„é€  rest.Config å¯¹è±¡ã€‚\n è¿è¡Œçš„ Pod å†…éƒ½ä¼šå­˜å‚¨ä¸€ä¸ª\næ¯ä¸ª ServiceAccount éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ Secretï¼Œè¿™ä¸ª Secret åŒ…å«äº†å¯¹é›†ç¾¤çš„æ“ä½œæƒé™ã€‚\n package main import ( \u0026#34;k8s.io/client-go/rest\u0026#34; ) func KubeConfig() *rest.Config { config, err := rest.InClusterConfig() if err != nil { panic(err) } return config } é€šè¿‡ controller-runtime å¿«é€Ÿè·å– ä½¿ç”¨ sigs.k8s.io/controller-runtime åŒ…å¿«é€Ÿè·å– rest.Config å¯¹è±¡ã€‚\nä¼˜å…ˆçº§ï¼š\n ä» --kubeconfig æŒ‡å®šçš„æ–‡ä»¶è·å– ä» KUBECONFIG ç¯å¢ƒå˜é‡é…ç½®çš„æ–‡ä»¶è·å– è¿è¡Œåœ¨é›†ç¾¤ä¸­ï¼Œä»¥ In-cluster æ–¹å¼è·å– ä» $HOME/.kube/config æ–‡ä»¶è·å–   ä¼˜ç‚¹ï¼šçµæ´»ï¼Œå¯¹é…ç½®å‹å¥½ï¼Œæ¨èä½¿ç”¨è¯¥ç§æ–¹å¼æ¥è·å– rest.Config å¯¹è±¡ã€‚\n package main import ( \u0026#34;k8s.io/client-go/rest\u0026#34; ctrl \u0026#34;sigs.k8s.io/controller-runtime\u0026#34; ) func KubeConfig() *rest.Config { config, err := ctrl.GetConfig() if err != nil { panic(err) } return config } é€šè¿‡æ–‡æœ¬æ„é€  ä» kubeconfig æ–‡æœ¬è·å– rest.Config å¯¹è±¡ã€‚ ä¾‹å¦‚å¯ä»¥ç”¨äºå¤šé›†ç¾¤ç®¡ç†å¹³å°ï¼Œéƒ½è¿‡ç§Ÿæˆ·ä¸Šä¼ çš„ kubeconfig æ¥å®ä¾‹åŒ– rest.Config å¯¹è±¡ã€‚\npackage main import ( \u0026#34;io/ioutil\u0026#34; \u0026#34;k8s.io/client-go/rest\u0026#34; \u0026#34;k8s.io/client-go/tools/clientcmd\u0026#34; ) var fakeConfig = `--- apiVersion: v1 clusters: - cluster: certificate-authority-data: cert-xxx server: https://127.0.0.1:6443 name: cluster-t2ktl contexts: - context: cluster: cluster-t2ktl namespace: default user: user-7k89b name: context-ctc98 current-context: context-ctc98 kind: Config preferences: {} users: - name: user-7k89b user: token: token-xxx ` func KubeConfig() *rest.Config { realConfig, _ := ioutil.ReadFile(clientcmd.RecommendedHomeFile) fakeConfig = string(realConfig) client, err := clientcmd.RESTConfigFromKubeConfig([]byte(fakeConfig)) if err != nil { panic(err) } return client } ","permalink":"https://srcio.cn/series/programming-kubernetes/rest-config/","summary":"æœ¬èŠ‚ä»‹ç»å‡ ç§æ„é€  rest.Config å®ä¾‹çš„åœºæ™¯æˆ–è€…æ–¹æ³•ã€‚ rest.Config å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ„å»ºå„ç§ç±»å‹çš„ Kubernetes å®¢æˆ·ç«¯å®ä¾‹ï¼Œä»è€Œè®¿é—® Kubernetes APIServerã€‚ é€šè¿‡ kubeconfig æ–‡ä»¶æ„é€  ç¨‹åºé€šè¿‡è¯»å– kubeconfig æ–‡","title":"æ„é€  rest.Config å®ä¾‹"},{"content":"å®‰è£…çš„ Go1.18 æˆ–æ›´æ–°ç‰ˆæœ¬ï¼Œå®ƒä¸ºä½ æä¾›äº†å·¥ä½œåŒºæ¨¡å¼ï¼ˆWorkspace modeï¼‰ï¼Œå¸®åŠ©ä½ æ›´å¥½åš go æ¨¡å—ä¹‹é—´ä¾èµ–çš„ç®¡ç†ã€‚\nä¾‹å¦‚ï¼Œä½ å¼€å‘ä¸€ä¸ªæ–°é¡¹ç›®ï¼Œåˆ†äº†ä¸¤ä¸ª go moduleï¼Œåˆ†åˆ«ä¸º service-a å’Œ service-bï¼Œservice-a ä¾èµ–äº†service-b ï¼Œç°åœ¨é¡¹ç›®è¿˜å¤„äºå¼€å‘é˜¶æ®µï¼Œæˆ‘ä»¬éƒ½æ˜¯è¿™ä¹ˆå¤„ç†çš„ã€‚\nåˆ›å»ºé¡¹ç›®ç›®å½•ï¼š\nmkdir service cd service åˆ›å»º service-b æ¨¡å—:\nmkdir service-b cd service-b go mod init github.com/srcio/service-b ç¼–å†™ service-b æ¨¡å—ä»£ç ï¼š\nmkdir greeting vim greeting/hello.go package greeting import \u0026#34;fmt\u0026#34; func Hello(name string){ fmt.Println(\u0026#34;Hello, \u0026#34; + name) } ç»§ç»­åˆ›å»º service-a æ¨¡å—ï¼š\ncd .. mkdir service-a cd service-a go mod init github.com/srcio/service-a å› ä¸º service-a éœ€è¦ä¾èµ–æœ¬åœ°å¼€å‘çš„ service-b ç±»åº“ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ go.mod ä¸­å¼•å…¥ service-a ï¼š\nvim go.mod module github.com/srcio/service-a go 1.18 require( github.com/srcio/service-b v1.0.0 ) replace( github.com/srcio/service-a v1.0.0 =\u0026gt; ../service-b ) ç„¶åï¼Œç¼–å†™ä¸»å‡½æ•°ä»£ç ï¼š\nvim main.go package main import( \u0026#34;github.com/srcio/service-b/greeting\u0026#34; ) func main(){ greeting.Hello() } åœ¨ä¸Šè¿°çš„æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œä½ ä¼šå‘ç°ï¼Œæˆ‘ä»¬å¼•ç”¨äº†æœ¬åœ°çš„ä»£ç ç±»åº“ github.com/srcio/service-b v1.0.0 =\u0026gt; ../service-bã€‚è€Œä¸”ï¼Œå¦‚æœæ­¤æ—¶åˆ«çš„å¼€å‘è€…å’Œä½ ä¸€èµ·åä½œå¼€å‘ service-a moduleçš„æ—¶å€™ï¼Œä»–æ˜¯æ— æ³•å¼•ç”¨åˆ°è¿™ä¸ªç±»åº“çš„ï¼ˆé™¤éä»–æœ¬åœ°ä¹ŸåŒæ­¥äº†../service-bï¼‰ã€‚\nç°åœ¨ä½ å°±å¯ä»¥é€šè¿‡ go work æ¥è§£å†³è¿™ç§çƒ¦æ¼äº†ã€‚\né¦–å…ˆï¼Œä½ è¦åšçš„æ˜¯å›åˆ°moduleçš„å¤–é¢ï¼Œç„¶åæ‰§è¡Œ go work init å‘½ä»¤ï¼š\ncd .. go work init service-a go work init service-b æ­¤æ—¶ï¼Œä½ ä¼šå‘ç°ï¼Œç›®å½•ä¸‹å¤šäº†ä¸ªgo.workæ–‡ä»¶ï¼ŒæŸ¥çœ‹è¯¥æ–‡ä»¶å†…å®¹ï¼š\n$ cat go.work go 1.18 use( ./service-a ./service-b ) module ä¾èµ–çš„ç±»åº“ç›®å½•å°±åœ¨ use å—ä¸­ï¼Œæ­¤æ—¶ï¼Œä½ å¯ä»¥åˆ é™¤ service-aç›®å½•ä¸‹ go.mod ä¸­çš„ replace å—ï¼Œç„¶åè¿è¡Œ main å‡½æ•°äº†ï¼š\ncd service-a \u0026amp;\u0026amp; go run main.go # æˆ–è€…ä½ å¯ä»¥ç›´æ¥åœ¨å·¥ä½œåŒºç›®å½•è¿è¡Œ go run service-a/main.go å¦‚æœä½ çš„ä¸»é¡¹ç›®ä¾èµ–å¤šä¸ªæœ¬åœ°ç±»åº“ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ·»åŠ \ngo work use service-c go work use service-d æœ€åï¼Œä½ å¯ä»¥é€šè¿‡ go help workï¼Œäº†è§£æ›´å¤šã€‚\n","permalink":"https://srcio.cn/series/programming-go/go-work/","summary":"å®‰è£…çš„ Go1.18 æˆ–æ›´æ–°ç‰ˆæœ¬ï¼Œå®ƒä¸ºä½ æä¾›äº†å·¥ä½œåŒºæ¨¡å¼ï¼ˆWorkspace modeï¼‰ï¼Œå¸®åŠ©ä½ æ›´å¥½åš go æ¨¡å—ä¹‹é—´ä¾èµ–çš„ç®¡ç†ã€‚ ä¾‹å¦‚ï¼Œä½ å¼€å‘ä¸€ä¸ªæ–°é¡¹ç›®ï¼Œåˆ†äº†ä¸¤ä¸ª","title":"Go1.18 - å·¥ä½œåŒºæ¨¡å¼"},{"content":"Giscus  å¼€æºã€æ— å¹¿å‘Šã€æ°¸ä¹…å…è´¹ æ”¯æŒå¤šè¯­è¨€ æ”¯æŒè¡¨æƒ…åé¦ˆ æ”¯æŒæ‡’åŠ è½½  å¿…è¦æ¡ä»¶  ä½ çš„åšå®¢æ‰€ç”¨çš„ GitHub çš„ä»“åº“å¿…é¡»æ˜¯ Publicï¼Œå¹¶ä¸”å¼€é€šäº† Dicussion åŠŸèƒ½ï¼› å®‰è£… giscus.appï¼Œå®‰è£…çš„æ—¶å€™ï¼Œåˆ†é…ä½ çš„åšå®¢æ‰€ç”¨çš„ GitHub ä»“åº“å³å¯ã€‚   å½“ç„¶ï¼Œå¦‚æœä½ çš„åšå®¢æ²¡æœ‰æ‰˜ç®¡åœ¨ Github ä¸Šï¼Œä½ ä¹Ÿå¯ä»¥å•ç‹¬åˆ›å»ºä¸€ä¸ª Github ä»“åº“ä½œä¸ºå¼€é€š giscus è¯„è®ºã€‚\n ä½¿ç”¨å§¿åŠ¿  åœ¨ giscus.app åšè‡ªå®šä¹‰é…ç½®ï¼Œå¡«å…¥ä½ çš„ä»“åº“åç§°ï¼Œé€‰æ‹©ä¸»é¢˜ç­‰ï¼ŒGiscus ä¼šè‡ªåŠ¨å¸®ä½ ç”Ÿæˆ javascript è„šæœ¬ï¼› Hugo åšå®¢ç›®å½•ä¸‹ï¼Œåˆ›å»º layouts/partials/comments.html æ–‡ä»¶ï¼Œå†™å…¥è·å–çš„è„šæœ¬ï¼š  \u0026lt;script src=\u0026#34;https://giscus.app/client.js\u0026#34; data-repo=\u0026#34;[åœ¨æ­¤è¾“å…¥ä»“åº“]\u0026#34; data-repo-id=\u0026#34;[åœ¨æ­¤è¾“å…¥ä»“åº“ ID]\u0026#34; data-category=\u0026#34;[åœ¨æ­¤è¾“å…¥åˆ†ç±»å]\u0026#34; data-category-id=\u0026#34;[åœ¨æ­¤è¾“å…¥åˆ†ç±» ID]\u0026#34; data-mapping=\u0026#34;pathname\u0026#34; data-strict=\u0026#34;0\u0026#34; data-reactions-enabled=\u0026#34;1\u0026#34; data-emit-metadata=\u0026#34;0\u0026#34; data-input-position=\u0026#34;bottom\u0026#34; data-theme=\u0026#34;light\u0026#34; data-lang=\u0026#34;zh-CN\u0026#34; crossorigin=\u0026#34;anonymous\u0026#34; async\u0026gt; \u0026lt;/script\u0026gt;  âš ï¸æ³¨æ„ï¼šä¸ºäº†ä½¿ä¸‹é¢çš„ javascript è„šæœ¬ç”Ÿæ•ˆï¼Œdata-theme é€‰æ‹© lightï¼›æˆ–è€…ä½ å¯ä»¥æ ¹æ®ä½ é€‰æ‹©çš„ä¸»é¢˜ä¿®æ”¹ä¸‹é¢çš„ javascript è„šæœ¬ã€‚\n è‡ªåŠ¨ä¸»é¢˜  ä½¿ç”¨ä¸€ä¸ª div ä½œä¸ºè¯„è®ºåŒºåŸŸçš„å®¹å™¨  \u0026lt;div class=\u0026#34;giscus_comments\u0026#34;\u0026gt; {{- partial \u0026#34;comments.html\u0026#34; . }} \u0026lt;/div\u0026gt; åœ¨è¯¥å®¹å™¨ä¸‹æ–¹å†™å…¥ä¸»é¢˜è‡ªåŠ¨åˆ‡æ¢çš„è¯­å¥  \u0026lt;script\u0026gt; document.querySelector(\u0026#34;div.giscus_comments \u0026gt; script\u0026#34;) .setAttribute( \u0026#34;data-theme\u0026#34;, localStorage.getItem(\u0026#34;pref-theme\u0026#34;) ? localStorage.getItem(\u0026#34;pref-theme\u0026#34;) : window.matchMedia(\u0026#34;(prefers-color-scheme: dark)\u0026#34;).matches ? \u0026#34;dark\u0026#34; : \u0026#34;light\u0026#34;), document.querySelector(\u0026#34;#theme-toggle\u0026#34;).addEventListener(\u0026#34;click\u0026#34;, () =\u0026gt; { let e = document.querySelector(\u0026#34;iframe.giscus-frame\u0026#34;); e \u0026amp;\u0026amp; e.contentWindow.postMessage({ giscus: { setConfig: { theme: localStorage.getItem(\u0026#34;pref-theme\u0026#34;) ? localStorage.getItem(\u0026#34;pref-theme\u0026#34;) === \u0026#34;dark\u0026#34; ? \u0026#34;light\u0026#34; : \u0026#34;dark\u0026#34; : document.body.className.includes(\u0026#34;dark\u0026#34;) ? \u0026#34;light\u0026#34; : \u0026#34;dark\u0026#34; } } }, \u0026#34;https://giscus.app\u0026#34;) }) \u0026lt;/script\u0026gt; ğŸ”— é“¾æ¥  åº”ç”¨ï¼šhttps://github.com/apps/giscus æºç ï¼šhttps://github.com/giscus/giscus ä½¿ç”¨ï¼šhttps://giscus.app  ","permalink":"https://srcio.cn/posts/use-giscus/","summary":"Giscus å¼€æºã€æ— å¹¿å‘Šã€æ°¸ä¹…å…è´¹ æ”¯æŒå¤šè¯­è¨€ æ”¯æŒè¡¨æƒ…åé¦ˆ æ”¯æŒæ‡’åŠ è½½ å¿…è¦æ¡ä»¶ ä½ çš„åšå®¢æ‰€ç”¨çš„ GitHub çš„ä»“åº“å¿…é¡»æ˜¯ Publicï¼Œå¹¶ä¸”å¼€é€šäº† Dicussion åŠŸèƒ½ï¼› å®‰è£… giscus","title":"ä½¿ç”¨ Giscus ä½œä¸ºåšå®¢è¯„è®ºç³»ç»Ÿ"},{"content":"æœ¬èŠ‚ä»‹ç» Golang ç¨‹åºå¦‚ä½•é€šè¿‡ rest.Config å®ä¾‹è·å–å„ç§ç±»å‹çš„ Kubernetes å®¢æˆ·ç«¯å®ä¾‹ã€‚ é€šè¿‡å®¢æˆ·ç«¯è®¿é—® Kubernetes ä¸­çš„ API èµ„æºå®ä¾‹ã€‚\nClientset  è·å– *kubernetes.Clientset\næ¨èä½¿ç”¨è¯¥å®¢æˆ·ç«¯å®ä¾‹å»æ“ä½œ K8s API èµ„æºã€‚  package main import ( \u0026#34;k8s.io/client-go/kubernetes\u0026#34; \u0026#34;k8s.io/client-go/rest\u0026#34; ) func Clientset(config *rest.Config) *kubernetes.Clientset { client, err := kubernetes.NewForConfig(config) if err != nil { panic(err) } return client } è·å– *rest.RESTClient\nå¯ä»¥é€šè¿‡è¯¥å®¢æˆ·ç«¯å®ä¾‹è·å–å†…ç½®çš„ä»¥åŠè‡ªå®šä¹‰çš„ K8s API èµ„æºã€‚  package main import \u0026#34;k8s.io/client-go/rest\u0026#34; func RESTClient(config *rest.Config) *rest.RESTClient { client, err := rest.RESTClientFor(config) if err != nil { panic(err) } return client } DiscoveryClient DiscoveryClient åŠ¨æ€å®¢æˆ·ç«¯ï¼Œé€šè¿‡åŠ¨æ€æŒ‡å®š GVR æ¥æ“ä½œä»»æ„çš„ Kubernetes èµ„æºï¼ˆå†…ç½®èµ„æº + CRï¼‰\n ä½¿ç”¨åµŒå¥—çš„ map[string]interface{} ç»“æ„å­˜å‚¨èµ„æºæ•°æ®ï¼› å¯ä»¥åˆ©ç”¨åå°„æœºåˆ¶åºåˆ—åŒ–æˆä¸ºç‰¹å®šèµ„æºå®ä½“ï¼› çµæ´»æ€§æ›´é«˜ï¼Œä½†æ— æ³•åšå¼ºæ•°æ®ç±»å‹æ£€æŸ¥å’ŒéªŒè¯ã€‚  ä½¿ç”¨ DiscoveryClient è·å–åˆ°çš„èµ„æºå¯¹è±¡ä¸º runtime.Objectï¼Œå¯ä»¥é€šè¿‡ [``]\nè·å– DiscoveryClient å¯ä»¥é€šè¿‡è¯¥å®¢æˆ·ç«¯å®ä¾‹è·å–å†…ç½®çš„ä»¥åŠè‡ªå®šä¹‰çš„ K8s API èµ„æºã€‚\npackage main import ( \u0026#34;k8s.io/client-go/discovery\u0026#34; \u0026#34;k8s.io/client-go/rest\u0026#34; ) func DiscoveryClient(config *rest.Config) *discovery.DiscoveryClient { client, err := discovery.NewDiscoveryClientForConfig(config) if err != nil { panic(err) } return client } ä½¿ç”¨ DiscoveryClient DynamicClient è·å– dynamic.Interface\npackage client import ( \u0026#34;k8s.io/client-go/dynamic\u0026#34; \u0026#34;k8s.io/client-go/rest\u0026#34; ) func DynamicClient(config *rest.Config) dynamic.Interface { client, err := dynamic.NewForConfig(config) if err != nil { panic(err) } return client } è·å– runtimecli.Client\nå¯ä»¥é€šè¿‡è¯¥å®¢æˆ·ç«¯å®ä¾‹è·å–å†…ç½®çš„ä»¥åŠè‡ªå®šä¹‰çš„ K8s API èµ„æºã€‚ ä½†æ˜¯å¦‚æœè¯¥å®¢æˆ·ç«¯å®ä¾‹éœ€è¦æ“ä½œè‡ªå®šä¹‰ K8s API èµ„æºï¼ŒNew å‡½æ•°ä¼ å…¥çš„å‚æ•° runtimecli.Options ä¸­ Scheme å¯¹è±¡éœ€è¦è°ƒæ•´ã€‚  package main import ( \u0026#34;k8s.io/apimachinery/pkg/runtime\u0026#34; \u0026#34;k8s.io/client-go/kubernetes/scheme\u0026#34; \u0026#34;k8s.io/client-go/rest\u0026#34; runtimecli \u0026#34;sigs.k8s.io/controller-runtime/pkg/client\u0026#34; // å‡è®¾å®šä¹‰äº†ä¸€ä¸ª foo CRDï¼Œé‡Œé¢åŒ…å« register.go ä¸­å®šä¹‰äº† AddToScheme å®ä¾‹ \tfoosv1 \u0026#34;pkg/apis/foos/v1\u0026#34; ) func RuntimeClient(config *rest.Config) runtimecli.Client { client, err := runtimecli.New(config, runtimecli.Options{ Scheme: scheme.Scheme, }) if err != nil { panic(err) } return client } func RuntimeClientForCRD(config *rest.Config) runtimecli.Client { crScheme := runtime.NewScheme() foosv1.AddToScheme(scheme.Scheme) client, err := runtimecli.New(config, runtimecli.Options{ Scheme: crScheme, }) if err != nil { panic(err) } return client } è·å– *http.Client\næœ€åŸç”Ÿçš„å®¢æˆ·ç«¯ï¼Œä½¿ç”¨è¯¥å®¢æˆ·ç«¯å®ä¾‹æ“ä½œ K8s API èµ„æºå°±çº¯é è‡ªå·±æ‰‹å·¥å°è£…äº†ï¼Œä¸å¤ªæ¨èã€‚  package main import ( \u0026#34;net/http\u0026#34; \u0026#34;k8s.io/client-go/rest\u0026#34; ) func HTTPClient(config *rest.Config) *http.Client { client, err := rest.HTTPClientFor(config) if err != nil { panic(err) } return client } æ€»ç»“ http.Client =\u0026gt; rest.RESTClient =\u0026gt; discovery.DiscoveryClient =\u0026gt; kubernetes.Clientset\nå®¢æˆ·ç«¯çš„å®šåˆ¶åŒ–è¶Šé«˜ï¼Œä½¿ç”¨è¶Šé«˜æ•ˆã€‚ä½†åŒæ—¶å¯¹è‡ªå®šä¹‰ API çš„èµ„æºæ“ä½œçš„æ”¯æŒå°±è¶Šä½ã€‚\n","permalink":"https://srcio.cn/series/programming-kubernetes/kube-client/","summary":"æœ¬èŠ‚ä»‹ç» Golang ç¨‹åºå¦‚ä½•é€šè¿‡ rest.Config å®ä¾‹è·å–å„ç§ç±»å‹çš„ Kubernetes å®¢æˆ·ç«¯å®ä¾‹ã€‚ é€šè¿‡å®¢æˆ·ç«¯è®¿é—® Kubernetes ä¸­çš„ API èµ„æºå®ä¾‹ã€‚ Clientset è·å– *kubernetes.Clientset æ¨èä½¿ç”¨è¯¥å®¢æˆ·ç«¯å®ä¾‹å»æ“ä½œ K8s API èµ„æºã€‚ package main import (","title":"æ„é€  Kubernetes å®¢æˆ·ç«¯å®ä¾‹"},{"content":"æœ¯è¯­ Group\nAPI èµ„æºç½®äºæŸä¸ªåˆ†ç»„ä¸‹ï¼Œç»„ä½œä¸ºç›¸å…³åŠŸèƒ½çš„é›†åˆã€‚ä¸€ä¸ªç»„åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç‰ˆæœ¬ã€‚\nVersion\nAPI èµ„æºçš„ç‰ˆæœ¬ï¼ŒAPI èµ„æºç‰ˆæœ¬æ˜¯ä¼šä¸æ–­è¿­ä»£çš„ã€‚\nKind\nAPI èµ„æºçš„çš„ç±»å‹ï¼Œç”¨äºå­˜å‚¨ API èµ„æºçš„æè¿°ä¿¡æ¯æˆ–çŠ¶æ€ç­‰ã€‚åŒä¸€ä¸ª Kind çš„ API èµ„æºå¯ä»¥æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œéšç€ç‰ˆæœ¬çš„ä¸æ–­è¿­ä»£ï¼ŒKind ä»£è¡¨çš„èµ„æºçš„ä¼šæœ‰å­—æ®µå†…å®¹çš„æ›´æ”¹ã€‚\nGVK\nGroup/Version/Kindï¼Œä¾‹å¦‚ Deploymentï¼š\napiVersion:apps/v1kind:Deploymentmetadata:- name:deploy-1... ä¸Šé¢çš„ä»£ç ç¤ºä¾‹æè¿°äº†ä¸€ä¸ª API èµ„æºå¯¹è±¡ï¼Œè¿™ä¸ªèµ„æºå¯¹è±¡ï¼š\n Group æ˜¯ apps Version æ˜¯ v1 Kind æ˜¯ Deploymentã€‚   Resource\nä»£è¡¨ API èµ„æºï¼Œä¸ GVK ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚\nGVR\nå¯ä»¥å°† GVK æ¯”ä½œæ˜¯ä¸€ä¸ªç±»ï¼ŒGVR å°±æ˜¯è¿™ä¸ª GVK ç±»çš„å®ä¾‹ã€‚\nå½“æˆ‘ä»¬ä»¥ REST çš„æ–¹å¼å‘å‘èµ· API èµ„æºçš„è¯·æ±‚æ˜¯ï¼Œè¯·æ±‚ URL æ ¼å¼ä¸€èˆ¬ç±»ä¼¼è¿™æ ·ï¼š/api/apps/v1/deploymentsï¼Œé‡Œé¢å°±åŒ…å«äº†ä¸‰ä¸ªä¸Šé¢æåˆ°çš„æœ¯è¯­æ¦‚å¿µï¼š\n /appsï¼šè¯·æ±‚èµ„æºæ‰€åœ¨çš„ç»„ï¼ˆGroupï¼‰ /v1ï¼šè¯·æ±‚èµ„æºçš„ç‰ˆæœ¬ï¼ˆVersionï¼‰ /deploymentsï¼šè¯·æ±‚çš„èµ„æºçš„åç§°ï¼ˆResourceï¼‰  ","permalink":"https://srcio.cn/series/programming-kubernetes/api-design/","summary":"æœ¯è¯­ Group API èµ„æºç½®äºæŸä¸ªåˆ†ç»„ä¸‹ï¼Œç»„ä½œä¸ºç›¸å…³åŠŸèƒ½çš„é›†åˆã€‚ä¸€ä¸ªç»„åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç‰ˆæœ¬ã€‚ Version API èµ„æºçš„ç‰ˆæœ¬ï¼ŒAPI èµ„æºç‰ˆæœ¬æ˜¯ä¼šä¸æ–­è¿­ä»£çš„ã€‚ Kind API èµ„æºçš„çš„ç±»å‹ï¼Œ","title":"Kubernetes API è®¾è®¡"},{"content":"","permalink":"https://srcio.cn/series/programming-kubernetes/operator/","summary":"","title":"Kuberentes Operator"},{"content":"æœ¬é¡µæ˜¯è¿™ç¯‡Kubernetes æ–‡æ¡£ä¸­ä¸€äº›å†…å®¹æ‘˜è¦ã€‚\nå¤§è‡´åˆ†ä¸º 3 ä¸ªæ­¥éª¤ï¼š\n ä¸º API ç±»å‹ç»“æ„åš tag æ ‡ç­¾ åœ¨ API ç±»å‹ä¾‹å¦‚ pkg/apis/${Group}/${Version}/types.go ä¸­çš„ Pod ç»“æ„ä½“ä¸Šæ‰“æ ‡ç­¾ï¼Œæ”¯æŒçš„æ ‡ç­¾ï¼š   // +genclientï¼šç”Ÿæˆå®¢æˆ·ç«¯å‡½æ•°ï¼ˆåŒ…æ‹¬ Create, Update, Delete, DeleteCollection, Get, List, Update, Patch, Watchï¼Œå¦‚æœ API ç±»å‹ç»“æ„ä¸­åŒ…æ‹¬ .Status å­—æ®µï¼Œè¿˜ä¼šé¢å¤–ç”Ÿæˆ UpdateStatus å‡½æ•°ï¼‰ï¼› // +genclient:nonNamespacedï¼šæŒ‡å®š API ç±»å‹æ˜¯é›†ç¾¤çº§åˆ«è€Œä¸æ˜¯å‘½åç©ºé—´çº§åˆ«çš„ï¼Œç”Ÿæˆçš„å®¢æˆ·ç«¯å‡½æ•°éƒ½æ²¡æœ‰å‘½åç©ºé—´ï¼› // +genclient:onlyVerbs=create,getï¼šåªç”Ÿæˆ Create, Get å®¢æˆ·ç«¯å‡½æ•°ï¼› // +genclient:skipVerbs=watchï¼šç”Ÿæˆé™¤äº† Watch ä¹‹å¤–çš„æ‰€æœ‰å…¶ä»–å®¢æˆ·ç«¯å‡½æ•°ï¼› // +genclient:noStatusï¼šå³ä½¿ API ç±»å‹ç»“æ„åŒ…å« .Status å­—æ®µï¼Œä¹Ÿä¸ç”Ÿæˆ UpdateStatus å®¢æˆ·ç«¯å‡½æ•°ï¼› æœ‰äº›æƒ…å†µä¸‹ï¼Œå¯èƒ½ä½ æƒ³è¦é¢å¤–ç”Ÿæˆéæ ‡å‡†çš„å®¢æˆ·ç«¯å‡½æ•°ï¼Œä¾‹å¦‚å­èµ„æºå‡½æ•°ï¼Œé‚£ä¹ˆä½ éœ€è¦ä½¿ç”¨ä¸‹åˆ—è¿™äº› tag æ ‡ç­¾ï¼š // +genclient:method=Scale,verb=update,subresource=scale,input=k8s.io/api/extensions/v1beta1.Scale,result=k8s.io/api/extensions/v1beta1.Scaleï¼šè¯¥ä¾‹ä¸­ä½¿ç”¨æ ‡ç­¾ï¼Œå°†ä¼šè‡ªåŠ¨ç”Ÿæˆ Scale(string, *v1beta.Scale) *v1beta.Scale å®¢æˆ·ç«¯å‡½æ•°ï¼Œé‡Œé¢é…ç½®äº†å­èµ„æºå‡½æ•°çš„è¾“å…¥å’Œè¾“å‡ºå‚æ•°ã€‚ å¦å¤–ï¼Œä»¥ä¸‹çš„ tag æ ‡ç­¾ä¹Ÿå½±å“ç€å®¢æˆ·ç«¯ä»£ç çš„ç”Ÿæˆï¼š // +groupName=policy.authorization.k8s.ioï¼šä½¿ç”¨è¯¥ group åç§°ç”Ÿæˆåˆ°å®¢æˆ·ç«¯ä»£ç ä¸­ï¼ˆé»˜è®¤ä½¿ç”¨ package åï¼‰ï¼› // +groupGoName=AuthorizationPolicyï¼šé©¼å³° Golang æ ‡è¯†ç¬¦é¿å…å¸¦æœ‰éå”¯ä¸€å‰ç¼€ä¾‹å¦‚ policy.authorization.k8s.io å’Œ policy.k8s.io çš„ç»„åå†²çªã€‚è¿™å°†å¯èƒ½å¯¼è‡´ä¸¤ä¸ª Policy() å‡½æ•°ç”Ÿæˆåˆ° clientset ä»£ç ä¸­ã€‚  å¦‚æœä½ æ˜¯å‚ä¸å¼€å‘ k8s.io/kubernetes é¡¹ç›®ï¼Œä½ åªéœ€è¦æ‰§è¡Œ ./hack/update-group.sh è„šæœ¬å³å¯ç”Ÿæˆæˆ–æ›´æ–°ä»£ç ï¼› å¦‚æœä½ å¼€å‘è‡ªå·±çš„é¡¹ç›®ï¼Œä½ éœ€è¦ä½¿ç”¨ client-gen å‘½ä»¤ä»¥åŠå…¶å‘½ä»¤å‚æ•°ï¼š  client-gen --input=\u0026#34;pkg/apis/${group1}/${version1},pkg/apis/${group2}/${version2}\u0026#34; --clientset-name=\u0026#34;my_clientset\u0026#34;  ä½¿ç”¨ client-gen -h æŸ¥çœ‹æ›´å¤šå‘½ä»¤ä½¿ç”¨å§¿åŠ¿ã€‚\n é™¤äº† client-gen è‡ªåŠ¨ç”Ÿæˆçš„å®¢æˆ·ç«¯ä»£ç å¤–ï¼Œä½ å¯ä»¥æ‰‹åŠ¨æ·»åŠ é¢å¤–çš„ä»£ç ï¼Œå‚è€ƒè¿™é‡Œã€‚  ","permalink":"https://srcio.cn/series/programming-kubernetes/client-gen-usage/","summary":"æœ¬é¡µæ˜¯è¿™ç¯‡Kubernetes æ–‡æ¡£ä¸­ä¸€äº›å†…å®¹æ‘˜è¦ã€‚ å¤§è‡´åˆ†ä¸º 3 ä¸ªæ­¥éª¤ï¼š ä¸º API ç±»å‹ç»“æ„åš tag æ ‡ç­¾ åœ¨ API ç±»å‹ä¾‹å¦‚ pkg/apis/${Group}/${Version}/types.go ä¸­çš„ Pod ç»“æ„ä½“ä¸Šæ‰“æ ‡ç­¾ï¼Œæ”¯æŒçš„æ ‡ç­¾ï¼š // +","title":"ä½¿ç”¨ client-gen ç”Ÿæˆ clientset ä»£ç "}]